---
import '@/styles/global.css';
import { buildTitle, site } from '@/lib/site';

type Props = {
  title?: string;
  noindex?: boolean;
};

const { title, noindex = true } = Astro.props;
const fullTitle = buildTitle(title ? `CMS - ${title}` : 'CMS');
const pathname = Astro.url.pathname;

const navItems = [
  { label: 'Tableau de bord', href: '/cms' },
  { label: 'Demandes', href: '/cms/bookings' },
  { label: 'Avant/Apres', href: '/cms/avant-apres' },
  { label: 'Blog', href: '/cms/blog' },
  { label: 'Interventions', href: '/cms/interventions' }
];

const quickNew = [
  { label: 'Nouvelle demande', href: '/cms/bookings/new' },
  { label: 'Nouvel avant/apres', href: '/cms/avant-apres/new' },
  { label: 'Nouvel article', href: '/cms/blog/new' },
  { label: 'Nouvelle intervention', href: '/cms/interventions/new' }
];

function isActive(href: string) {
  if (href === '/cms') return pathname === '/cms' || pathname === '/cms/';
  return pathname.startsWith(`${href}/`) || pathname === href;
}
---

<!doctype html>
<html lang="fr">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    {noindex ? <meta name="robots" content="noindex,nofollow" /> : null}
    <title>{fullTitle}</title>

    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Fraunces:opsz,wght@9..144,500;9..144,700&family=Source+Sans+3:wght@400;600;700&display=swap"
      rel="stylesheet"
    />
    <meta property="og:locale" content={site.locale} />
    <meta property="og:type" content="website" />
    <meta property="og:title" content={fullTitle} />
  </head>
  <body class="font-body text-ink">
    <div class="min-h-screen bg-paper">
      <dialog
        id="cms-nav"
        class="fixed inset-0 m-0 h-full w-full bg-transparent p-0 backdrop:bg-black/30 sm:hidden"
      >
        <div class="h-full w-full bg-paper">
          <div class="flex items-center justify-between border-b border-ink/10 px-5 py-4">
            <div class="text-sm font-semibold uppercase tracking-wide text-ink/60">Navigation</div>
            <button
              type="button"
              class="rounded-full px-3 py-2 text-sm font-semibold text-ink/70 hover:text-ink"
              data-cms-close
            >
              Fermer
            </button>
          </div>
          <div class="space-y-8 px-5 py-6">
            <div>
              <div class="text-xs font-semibold uppercase tracking-wide text-ink/50">Espace</div>
              <div class="mt-3 space-y-2">
                {navItems.map((item) => (
                  <a
                    href={item.href}
                    class:list={[
                      'block rounded-xl px-4 py-3 text-sm font-semibold',
                      isActive(item.href) ? 'bg-mist text-ink' : 'text-ink/75 hover:text-ink'
                    ]}
                  >
                    {item.label}
                  </a>
                ))}
              </div>
            </div>
            <div>
              <div class="text-xs font-semibold uppercase tracking-wide text-ink/50">Nouveau</div>
              <div class="mt-3 space-y-2">
                {quickNew.map((item) => (
                  <a href={item.href} class="block rounded-xl border border-ink/10 bg-paper px-4 py-3 text-sm">
                    {item.label}
                  </a>
                ))}
              </div>
            </div>
          </div>
        </div>
      </dialog>

      <div class="flex min-h-screen">
        <aside class="hidden w-64 shrink-0 border-r border-ink/10 bg-mist/50 p-6 sm:flex sm:flex-col">
          <div class="flex items-center justify-between">
            <div>
              <div class="text-xs font-semibold uppercase tracking-wide text-ink/50">Cabinet</div>
              <div class="mt-1 font-display text-xl tracking-tight">Dr Sirine Soussi</div>
            </div>
          </div>

          <nav class="mt-8 space-y-2">
            {navItems.map((item) => (
              <a
                href={item.href}
                class:list={[
                  'rounded-xl px-4 py-3 text-sm font-semibold transition',
                  isActive(item.href) ? 'bg-paper text-ink shadow-soft' : 'text-ink/75 hover:text-ink'
                ]}
              >
                {item.label}
              </a>
            ))}
          </nav>

          <div class="mt-8">
            <div class="text-xs font-semibold uppercase tracking-wide text-ink/50">Nouveau</div>
            <div class="mt-3 space-y-2">
              {quickNew.map((item) => (
                <a href={item.href} class="block rounded-xl border border-ink/10 bg-paper px-4 py-3 text-sm">
                  {item.label}
                </a>
              ))}
            </div>
          </div>

          <div class="mt-auto pt-6 text-xs text-ink/50">UI uniquement — pas d’authentification.</div>
        </aside>

        <div class="flex min-h-screen flex-1 flex-col">
          <header class="flex items-center justify-between border-b border-ink/10 bg-paper px-4 py-4 sm:px-8">
            <div class="flex items-center gap-3">
              <button
                type="button"
                class="inline-flex items-center rounded-full border border-ink/10 bg-paper px-3 py-2 text-sm font-semibold text-ink/70 hover:text-ink sm:hidden"
                data-cms-open
              >
                Menu
              </button>
              <div>
                <div class="text-xs font-semibold uppercase tracking-wide text-ink/50">CMS</div>
                <div class="font-display text-xl tracking-tight">{title ?? 'Tableau de bord'}</div>
              </div>
            </div>

            <div class="flex items-center gap-3">
              <label class="hidden items-center gap-2 rounded-full border border-ink/10 bg-paper px-3 py-2 text-sm text-ink/60 sm:flex">
                <span>Rechercher</span>
                <input
                  type="text"
                  placeholder="Nom, intervention, date..."
                  class="w-48 bg-transparent text-sm text-ink/80 outline-none placeholder:text-ink/40"
                />
              </label>
              <a href="/" class="btn btn-pill btn-sm btn-secondary">Voir le site</a>
              <button type="button" class="btn btn-pill btn-sm btn-secondary" data-cms-logout>Deconnexion</button>
            </div>
          </header>

          <main class="flex-1 px-4 py-8 sm:px-8">
            <slot />
          </main>
        </div>
      </div>
    </div>

    <script is:inline>
      (() => {
        const dialog = document.getElementById('cms-nav');
        if (!(dialog instanceof HTMLDialogElement)) return;
        const openBtn = document.querySelector('[data-cms-open]');
        const closeBtn = dialog.querySelector('[data-cms-close]');
        if (!(openBtn instanceof HTMLElement) || !(closeBtn instanceof HTMLElement)) return;

        const open = () => dialog.showModal();
        const close = () => dialog.close();

        openBtn.addEventListener('click', open);
        closeBtn.addEventListener('click', close);
        dialog.addEventListener('click', (e) => {
          if (e.target === dialog) close();
        });
      })();
    </script>

    <script is:inline>
      (() => {
        const isLogin = window.location.pathname === '/cms/login' || window.location.pathname === '/cms/login/';
        if (!isLogin) {
          const authed = window.localStorage.getItem('cms-auth') === 'true';
          if (!authed) {
            window.location.href = '/cms/login';
            return;
          }
        }

        const logoutBtn = document.querySelector('[data-cms-logout]');
        if (logoutBtn instanceof HTMLButtonElement) {
          logoutBtn.addEventListener('click', () => {
            window.localStorage.removeItem('cms-auth');
            window.location.href = '/cms/login';
          });
        }
      })();
    </script>
  </body>
</html>
