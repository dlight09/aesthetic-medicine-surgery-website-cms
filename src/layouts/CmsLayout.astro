---
import '@/styles/global.css';
import '@/styles/cms.css';
import { buildTitle, site } from '@/lib/site';

type Props = {
  title?: string;
  noindex?: boolean;
};

const { title, noindex = true } = Astro.props;
const fullTitle = buildTitle(title ? `CMS - ${title}` : 'CMS');
const pathname = Astro.url.pathname;

const navItems = [
  {
    label: 'Tableau de bord',
    href: '/cms',
    icon: 'M4 5.5C4 4.67 4.67 4 5.5 4h4C10.33 4 11 4.67 11 5.5v4c0 .83-.67 1.5-1.5 1.5h-4C4.67 11 4 10.33 4 9.5v-4Zm9 0c0-.83.67-1.5 1.5-1.5h4c.83 0 1.5.67 1.5 1.5v4c0 .83-.67 1.5-1.5 1.5h-4c-.83 0-1.5-.67-1.5-1.5v-4Zm-9 9c0-.83.67-1.5 1.5-1.5h4c.83 0 1.5.67 1.5 1.5v4c0 .83-.67 1.5-1.5 1.5h-4c-.83 0-1.5-.67-1.5-1.5v-4Zm9 0c0-.83.67-1.5 1.5-1.5h4c.83 0 1.5.67 1.5 1.5v4c0 .83-.67 1.5-1.5 1.5h-4c-.83 0-1.5-.67-1.5-1.5v-4Z'
  },
  {
    label: 'Demandes',
    href: '/cms/bookings',
    icon: 'M6 5.75C6 4.78 6.78 4 7.75 4h8.5C17.22 4 18 4.78 18 5.75v10.5c0 .97-.78 1.75-1.75 1.75h-8.5C6.78 18 6 17.22 6 16.25v-1.5H5a2 2 0 0 1-2-2V7.25a2 2 0 0 1 2-2h1Zm3 2.75a1 1 0 0 0 0 2h6a1 1 0 1 0 0-2H9Zm0 4a1 1 0 0 0 0 2h4a1 1 0 1 0 0-2H9Z'
  },
  {
    label: 'Avant/Apres',
    href: '/cms/avant-apres',
    icon: 'M5 7.5C5 6.67 5.67 6 6.5 6h11c.83 0 1.5.67 1.5 1.5v9c0 .83-.67 1.5-1.5 1.5h-11C5.67 18 5 17.33 5 16.5v-9Zm3.25 2.5a1.25 1.25 0 1 0 0 2.5 1.25 1.25 0 0 0 0-2.5Zm8.75 5-2.75-3.5-3.25 4.25H17Z'
  },
  {
    label: 'Blog',
    href: '/cms/blog',
    icon: 'M6 5.75C6 4.78 6.78 4 7.75 4h8.5C17.22 4 18 4.78 18 5.75v12.5c0 .97-.78 1.75-1.75 1.75h-8.5C6.78 20 6 19.22 6 18.25V5.75Zm3 3.25a1 1 0 0 0 0 2h6a1 1 0 1 0 0-2H9Zm0 4a1 1 0 0 0 0 2h4a1 1 0 1 0 0-2H9Z'
  },
  {
    label: 'Interventions',
    href: '/cms/interventions',
    icon: 'M7 6a3 3 0 1 1 6 0v1h2.5a1.5 1.5 0 0 1 0 3H13v1a3 3 0 1 1-6 0v-1H4.5a1.5 1.5 0 0 1 0-3H7V6Z'
  }
];

function isActive(href: string) {
  if (href === '/cms') return pathname === '/cms' || pathname === '/cms/';
  return pathname.startsWith(`${href}/`) || pathname === href;
}
---

<!doctype html>
<html lang="fr">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    {noindex ? <meta name="robots" content="noindex,nofollow" /> : null}
    <title>{fullTitle}</title>

    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Fraunces:opsz,wght@9..144,500;9..144,700&family=Source+Sans+3:wght@400;600;700&display=swap"
      rel="stylesheet"
    />
    <meta property="og:locale" content={site.locale} />
    <meta property="og:type" content="website" />
    <meta property="og:title" content={fullTitle} />
  </head>
  <body class="cms font-body text-ink">
    <div class="cms-shell min-h-screen">
      <dialog
        id="cms-nav"
        class="fixed inset-0 m-0 h-full w-full bg-transparent p-0 backdrop:bg-black/30 sm:hidden"
      >
        <div class="h-full w-full bg-paper">
          <div class="flex items-center justify-between border-b border-ink/10 px-5 py-4">
            <div class="text-sm font-semibold uppercase tracking-wide text-ink/60">Navigation</div>
            <button
              type="button"
              class="rounded-full px-3 py-2 text-sm font-semibold text-ink/70 hover:text-ink"
              data-cms-close
            >
              Fermer
            </button>
          </div>
          <div class="space-y-8 px-5 py-6">
            <div>
              <div class="text-xs font-semibold uppercase tracking-wide text-ink/50">Espace</div>
              <div class="mt-3 space-y-2">
                {navItems.map((item) => (
                  <a
                    href={item.href}
                    class:list={[
                      'flex items-center gap-2 rounded-xl px-4 py-3 text-sm font-semibold',
                      isActive(item.href) ? 'bg-mist text-ink' : 'text-ink/75 hover:text-ink'
                    ]}
                  >
                    <svg
                      viewBox="0 0 24 24"
                      fill="none"
                      aria-hidden="true"
                      class:list={["cms-nav-icon", isActive(item.href) ? 'text-ink/80' : 'text-ink/50']}
                    >
                      <path d={item.icon} stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round" />
                    </svg>
                    {item.label}
                  </a>
                ))}
              </div>
            </div>
            <div>
              <a href="/cms/bookings/new" class="btn btn-pill btn-sm btn-primary w-full">Nouvelle demande</a>
            </div>
          </div>
        </div>
      </dialog>

      <div class="flex min-h-screen">
        <aside class="cms-sidebar hidden w-64 shrink-0 p-6 sm:flex sm:flex-col">
          <div class="flex items-center justify-between">
            <div>
              <div class="text-xs font-semibold uppercase tracking-wide text-ink/50">Cabinet</div>
              <div class="mt-1 font-display text-xl tracking-tight">Dr Sirine Soussi</div>
            </div>
          </div>

          <nav class="mt-8 space-y-2">
            {navItems.map((item) => (
              <a
                href={item.href}
                class:list={[
                  'cms-nav-link flex items-center gap-2',
                  isActive(item.href) ? 'cms-nav-link-active' : ''
                ]}
              >
                <svg
                  viewBox="0 0 24 24"
                  fill="none"
                  aria-hidden="true"
                  class:list={["cms-nav-icon", isActive(item.href) ? 'text-ink/80' : 'text-ink/50']}
                >
                  <path d={item.icon} stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round" />
                </svg>
                {item.label}
              </a>
            ))}
          </nav>

          <div class="mt-8">
            <a href="/cms/bookings/new" class="btn btn-pill btn-sm btn-primary w-full">Nouvelle demande</a>
          </div>

          <div class="mt-auto pt-6 text-xs text-ink/50">UI uniquement — pas d’authentification.</div>
        </aside>

        <div class="flex min-h-screen flex-1 flex-col">
          <header class="cms-topbar flex items-center justify-between px-4 py-4 sm:px-8">
            <div class="flex items-center gap-3">
              <button
                type="button"
                class="inline-flex items-center rounded-full border border-ink/10 bg-paper px-3 py-2 text-sm font-semibold text-ink/70 hover:text-ink sm:hidden"
                data-cms-open
              >
                Menu
              </button>
              <div>
                <div class="text-xs font-semibold uppercase tracking-wide text-ink/50">CMS</div>
                <div class="font-display text-xl tracking-tight">{title ?? 'Tableau de bord'}</div>
              </div>
            </div>

            <div class="flex items-center gap-3">
              <label class="hidden items-center gap-2 rounded-full border border-ink/10 bg-paper px-3 py-2 text-sm text-ink/60 sm:flex">
                <span>Rechercher</span>
                <input
                  type="text"
                  placeholder="Nom, intervention, date..."
                  class="w-48 bg-transparent text-sm text-ink/80 outline-none placeholder:text-ink/40"
                />
              </label>
              <a href="/" target="_blank" rel="noopener noreferrer" class="btn btn-pill btn-sm btn-secondary">
                Voir le site
                <svg
                  viewBox="0 0 24 24"
                  fill="none"
                  aria-hidden="true"
                  class="-mr-1 h-4 w-4"
                >
                  <path
                    d="M14 4h6v6M20 4l-9 9"
                    stroke="currentColor"
                    stroke-width="1.6"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                  />
                  <path
                    d="M20 14v4a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h4"
                    stroke="currentColor"
                    stroke-width="1.6"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                  />
                </svg>
              </a>
              <button type="button" class="btn btn-pill btn-sm btn-secondary" data-cms-logout>Deconnexion</button>
            </div>
          </header>

          <main class="flex-1 px-4 py-8 sm:px-8">
            <slot />
          </main>
        </div>
      </div>
    </div>

    <script is:inline>
      (() => {
        const dialog = document.getElementById('cms-nav');
        if (!(dialog instanceof HTMLDialogElement)) return;
        const openBtn = document.querySelector('[data-cms-open]');
        const closeBtn = dialog.querySelector('[data-cms-close]');
        if (!(openBtn instanceof HTMLElement) || !(closeBtn instanceof HTMLElement)) return;

        const open = () => dialog.showModal();
        const close = () => dialog.close();

        openBtn.addEventListener('click', open);
        closeBtn.addEventListener('click', close);
        dialog.addEventListener('click', (e) => {
          if (e.target === dialog) close();
        });
      })();
    </script>

    <script is:inline>
      (() => {
        const isLogin = window.location.pathname === '/cms/login' || window.location.pathname === '/cms/login/';
        if (!isLogin) {
          const authed = window.localStorage.getItem('cms-auth') === 'true';
          if (!authed) {
            window.location.href = '/cms/login';
            return;
          }
        }

        const logoutBtn = document.querySelector('[data-cms-logout]');
        if (logoutBtn instanceof HTMLButtonElement) {
          logoutBtn.addEventListener('click', () => {
            window.localStorage.removeItem('cms-auth');
            window.location.href = '/cms/login';
          });
        }
      })();
    </script>
  </body>
</html>
