---
import BaseLayout from '@/layouts/BaseLayout.astro';
import BeforeAfterSlider from '@/components/BeforeAfterSlider.astro';
import { getCollection } from 'astro:content';
import { getPublicAvantApresCase, type AvantApresCaseView } from '@/lib/cms/avantApres';

Astro.response.headers.set('Cache-Control', 'no-store');
const { id } = Astro.params;
type AvantApresCaseWithIntervention = AvantApresCaseView & {
  intervention_category?: string | null;
  intervention_slug?: string | null;
  description?: string | null;
  case_number?: number | null;
};
const item = (id ? await getPublicAvantApresCase(id) : null) as AvantApresCaseWithIntervention | null;
if (!item) {
  return Astro.redirect('/avant-apres');
}

const interventions = await getCollection('interventions');
const relatedIntervention =
  item.intervention_category && item.intervention_slug
    ? interventions.find((entry) => {
        const slug = entry.slug.split('/').filter(Boolean).slice(-1)[0] ?? entry.slug;
        return entry.data.category === item.intervention_category && slug === item.intervention_slug;
      })
    : null;
const interventionHref = relatedIntervention
  ? `/interventions/${relatedIntervention.data.category}/${item.intervention_slug}`
  : null;
const caseLabel = item.case_number ? `Cas ${String(item.case_number).padStart(2, '0')}` : null;
const pageTitle = caseLabel && relatedIntervention ? `${caseLabel} — ${relatedIntervention.data.title}` : item.title;
---

<BaseLayout title={pageTitle} description="Avant/après avec consentement. Les résultats varient selon chaque patient.">
  <section class="mx-auto max-w-5xl px-4 py-14">
    <a href="/avant-apres" class="text-sm font-semibold text-ink/70 hover:text-ink">← Avant/après</a>
    <h1 class="mt-3 font-display text-4xl tracking-tight">{caseLabel ?? 'Cas'}</h1>
    {relatedIntervention && interventionHref ? (
      <div class="mt-3 text-sm text-ink/70">
        Intervention associée: <a class="link" href={interventionHref}>{relatedIntervention.data.title}</a>
      </div>
    ) : null}
    {item.description ? <p class="mt-3 text-lg text-ink/75">{item.description}</p> : null}

    <div class="mt-6 text-sm text-ink/60">Glissez le curseur pour comparer.</div>
    <div class="mt-4">
      <BeforeAfterSlider beforeUrl={item.beforeUrl} afterUrl={item.afterUrl} />
    </div>

    <div class="mt-10 rounded-3xl border border-ink/10 bg-mist p-6 text-sm text-ink/75">
      Les résultats varient selon chaque patient. Toute publication se fait avec consentement.
    </div>
  </section>
</BaseLayout>
