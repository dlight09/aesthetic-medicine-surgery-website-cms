---
import BaseLayout from '@/layouts/BaseLayout.astro';
import { getCollection } from 'astro:content';
import { listPublicAvantApresCases, type AvantApresCaseView } from '@/lib/cms/avantApres';
import { interventionCategories } from '@/lib/interventions';

Astro.response.headers.set('Cache-Control', 'no-store');
const interventionCategory = Astro.url.searchParams.get('intervention_category');
const interventionSlug = Astro.url.searchParams.get('intervention_slug');
type AvantApresCaseWithIntervention = AvantApresCaseView & {
  intervention_category?: string | null;
  intervention_slug?: string | null;
  description?: string | null;
  case_number?: number | null;
};
let cases = (await listPublicAvantApresCases()) as AvantApresCaseWithIntervention[];
if (interventionCategory) {
  cases = cases.filter((item) => item.intervention_category === interventionCategory);
}
if (interventionSlug) {
  cases = cases.filter((item) => item.intervention_slug === interventionSlug);
}
if (interventionCategory || interventionSlug) {
  cases = cases.sort((a, b) => (a.case_number ?? 999) - (b.case_number ?? 999));
}

const interventions = await getCollection('interventions');
const interventionsByCategory = interventionCategories.map((category) => {
  const entries = interventions
    .filter((entry) => entry.data.category === category.key)
    .sort((a, b) => (a.data.order ?? 999) - (b.data.order ?? 999))
    .map((entry) => ({
      title: entry.data.title,
      slug: entry.slug.split('/').filter(Boolean).slice(-1)[0] ?? entry.slug,
      category: entry.data.category,
    }));
  return { ...category, entries };
});
const interventionMetaByRef = new Map(
  interventions.map((entry) => {
    const slug = entry.slug.split('/').filter(Boolean).slice(-1)[0] ?? entry.slug;
    return [
      `${entry.data.category}::${slug}`,
      {
        title: entry.data.title,
        href: `/interventions/${entry.data.category}/${slug}`,
      },
    ];
  }),
);
const matchingIntervention =
  interventionCategory && interventionSlug
    ? interventions.find((entry) => {
        const slug = entry.slug.split('/').filter(Boolean).slice(-1)[0] ?? entry.slug;
        return entry.data.category === interventionCategory && slug === interventionSlug;
      })
    : null;
const interventionTitle = matchingIntervention?.data.title;
const interventionHref = matchingIntervention
  ? `/interventions/${matchingIntervention.data.category}/${interventionSlug}`
  : null;
const getInterventionMeta = (item: AvantApresCaseWithIntervention) => {
  if (!item.intervention_category || !item.intervention_slug) return null;
  return interventionMetaByRef.get(`${item.intervention_category}::${item.intervention_slug}`) ?? null;
};
const formatCaseNumber = (value?: number | null) =>
  value ? `Cas ${String(value).padStart(2, '0')}` : null;

const casesByRef = new Map<string, AvantApresCaseWithIntervention[]>();
cases.forEach((item) => {
  if (!item.intervention_category || !item.intervention_slug) return;
  const ref = `${item.intervention_category}::${item.intervention_slug}`;
  const list = casesByRef.get(ref) ?? [];
  list.push(item);
  casesByRef.set(ref, list);
});
casesByRef.forEach((list, key) => {
  casesByRef.set(
    key,
    list.sort((a, b) => (a.case_number ?? 999) - (b.case_number ?? 999)),
  );
});

const categorySections = interventionsByCategory
  .map((category) => {
    const interventionsWithCases = category.entries
      .map((entry) => {
        const ref = `${entry.category}::${entry.slug}`;
        const list = casesByRef.get(ref) ?? [];
        return { ...entry, ref, cases: list };
      })
      .filter((entry) => entry.cases.length > 0);
    return {
      ...category,
      interventions: interventionsWithCases,
    };
  })
  .filter((category) => category.interventions.length > 0);
---

<BaseLayout title="Avant/Après" description="Galerie Avant/Après (lorsque disponible) avec consentement et mentions.">
  <section class="mx-auto max-w-6xl px-4 py-14">
    <h1 class="font-display text-4xl tracking-tight">Avant/Après</h1>
    {interventionTitle && interventionHref ? (
      <div class="mt-3 flex flex-wrap items-center gap-3 text-sm text-ink/70">
        <div>
          Intervention associée: <a class="link" href={interventionHref}>{interventionTitle}</a>
        </div>
        <a class="link" href="/avant-apres">Voir tous les cas</a>
      </div>
    ) : null}
    <p class="mt-4 max-w-3xl text-ink/75">
      Les résultats varient selon chaque patient. Les photos ne constituent pas une garantie de résultat.
      Toute publication se fait avec consentement.
    </p>

    {categorySections.length ? (
      <div class="mt-10 space-y-8">
        {categorySections.map((category) => (
          <section class="rounded-3xl border border-ink/10 bg-paper p-6 shadow-soft">
            <div class="flex flex-wrap items-start justify-between gap-3">
              <div>
                <div class="text-xs font-semibold uppercase tracking-wide text-ink/50">Catégorie</div>
                <h2 class="mt-2 font-display text-2xl tracking-tight">{category.title}</h2>
                <div class="mt-1 text-sm text-ink/60">{category.description}</div>
              </div>
            </div>

            <div class="mt-6 space-y-6">
              {category.interventions.map((intervention) => (
                <div class="rounded-3xl border border-ink/10 bg-mist/40 p-5">
                  <div class="flex flex-wrap items-center justify-between gap-3">
                    <div>
                      <div class="text-sm font-semibold text-ink/85">{intervention.title}</div>
                      <div class="text-xs text-ink/60">{intervention.cases.length} cas</div>
                    </div>
                    <a
                      class="link text-sm"
                      href={`/interventions/${intervention.category}/${intervention.slug}`}
                    >
                      Voir l’intervention →
                    </a>
                  </div>

                  <div class="mt-4 grid gap-4 sm:grid-cols-2">
                    {intervention.cases.map((item) => (
                      <a
                        href={`/avant-apres/${item.id}`}
                        class="group overflow-hidden rounded-3xl border border-ink/10 bg-paper shadow-soft transition hover:shadow-lift"
                      >
                        <div class="relative aspect-[4/3] w-full overflow-hidden">
                          <img src={item.afterUrl} alt="Après" class="absolute inset-0 h-full w-full object-cover" loading="lazy" />
                          <div class="pointer-events-none absolute inset-0 bg-[linear-gradient(to_top,rgba(20,20,19,0.55),transparent_55%)]"></div>
                          <div class="absolute inset-x-0 bottom-0 p-5 text-paper">
                            <div class="text-xs font-semibold uppercase tracking-wide text-paper/70">Avant / après</div>
                            <div class="mt-1 font-display text-2xl tracking-tight">
                              {formatCaseNumber(item.case_number) ?? 'Cas'}
                            </div>
                          </div>
                        </div>
                        <div class="p-5">
                          {item.description ? (
                            <div class="text-sm text-ink/70">{item.description}</div>
                          ) : null}
                          <div class="mt-3 text-sm font-semibold text-ink/80 transition group-hover:text-ink">
                            Voir le cas →
                          </div>
                        </div>
                      </a>
                    ))}
                  </div>
                </div>
              ))}
            </div>
          </section>
        ))}
      </div>
    ) : (
      <div class="mt-10 rounded-3xl border border-ink/10 bg-mist p-10 text-ink/75">
        {interventionTitle ? (
          <div>
            Aucun cas publié pour cette intervention pour le moment.
            <div class="mt-3">
              <a class="link" href="/avant-apres">Voir tous les cas</a>
            </div>
          </div>
        ) : (
          <>Galerie en cours de préparation.</>
        )}
      </div>
    )}
  </section>
</BaseLayout>
