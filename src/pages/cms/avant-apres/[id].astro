---
import CmsLayout from '@/layouts/CmsLayout.astro';
import { getCmsAvantApresCase, type AvantApresCaseView } from '@/lib/cms/avantApres';
import { getCollection } from 'astro:content';
import { interventionCategories } from '@/lib/interventions';

Astro.response.headers.set('Cache-Control', 'no-store');
const { id } = Astro.params;
type AvantApresCaseWithIntervention = AvantApresCaseView & {
  intervention_category?: string | null;
  intervention_slug?: string | null;
  description?: string | null;
};
const item = (id ? await getCmsAvantApresCase(id) : null) as AvantApresCaseWithIntervention | null;
if (!item) {
  return Astro.redirect('/cms/avant-apres');
}

const interventions = await getCollection('interventions');
const interventionsByCategory = interventionCategories.map((category) => {
  const items = interventions
    .filter((entry) => entry.data.category === category.key)
    .map((entry) => ({
      title: entry.data.title,
      slug: entry.slug.split('/').filter(Boolean).slice(-1)[0] ?? entry.slug,
      category: entry.data.category,
    }));
  return { label: category.title, key: category.key, items };
});
const currentInterventionRef =
  item.intervention_category && item.intervention_slug
    ? `${item.intervention_category}::${item.intervention_slug}`
    : '';
---

<CmsLayout title="Edition cas">
  <div class="grid gap-6 lg:grid-cols-[minmax(0,1fr)_320px]">
    <section class="cms-card p-7">
      <div class="text-xs font-semibold uppercase tracking-wide text-ink/50">Avant/Après</div>
      <h1 class="mt-2 font-display text-3xl tracking-tight">{item.title}</h1>

      <form id="aa-form" class="mt-8 grid gap-5" data-id={item.id}>
        <label class="grid gap-2 text-sm">
          <span class="font-semibold text-ink/80">Description avant / après</span>
          <textarea rows={3} class="cms-textarea" name="description">{item.description ?? ''}</textarea>
        </label>
        <label class="grid gap-2 text-sm">
          <span class="font-semibold text-ink/80">Intervention associée</span>
          <select class="cms-select" name="intervention_ref">
            <option value="">Aucune</option>
            {interventionsByCategory.map((group) => (
              <optgroup label={group.label}>
                {group.items.map((entry) => (
                  <option value={`${entry.category}::${entry.slug}`} selected={currentInterventionRef === `${entry.category}::${entry.slug}`}>
                    {entry.title}
                  </option>
                ))}
              </optgroup>
            ))}
          </select>
          <span class="text-xs text-ink/50">Le titre du cas reprend l’intervention sélectionnée.</span>
        </label>

        <div class="grid gap-4 sm:grid-cols-2">
          <div class="rounded-2xl border border-ink/10 bg-mist p-4">
            <div class="text-xs font-semibold uppercase tracking-wide text-ink/50">Avant</div>
            <img data-preview="before" src={item.beforeUrl} alt="Avant" class="mt-3 h-32 w-full rounded-xl object-cover" />
            <input type="file" accept="image/*" class="mt-3 block text-xs" data-upload="before" />
            <div class="mt-2 text-[11px] text-ink/50">JPG/PNG, 10MB max.</div>
            <div data-upload-status="before" class="mt-1 text-[11px] text-ink/60"></div>
            <div data-upload-error="before" class="mt-1 text-[11px] text-rose-600"></div>
            <input type="hidden" name="before_path" data-path="before" value={item.before_path} />
          </div>
          <div class="rounded-2xl border border-ink/10 bg-mist p-4">
            <div class="text-xs font-semibold uppercase tracking-wide text-ink/50">Après</div>
            <img data-preview="after" src={item.afterUrl} alt="Après" class="mt-3 h-32 w-full rounded-xl object-cover" />
            <input type="file" accept="image/*" class="mt-3 block text-xs" data-upload="after" />
            <div class="mt-2 text-[11px] text-ink/50">JPG/PNG, 10MB max.</div>
            <div data-upload-status="after" class="mt-1 text-[11px] text-ink/60"></div>
            <div data-upload-error="after" class="mt-1 text-[11px] text-rose-600"></div>
            <input type="hidden" name="after_path" data-path="after" value={item.after_path} />
          </div>
        </div>

      </form>
    </section>

    <aside class="cms-panel p-6">
      <div class="text-xs font-semibold uppercase tracking-wide text-ink/50">Consentement</div>
      <label class="mt-3 flex items-center gap-2 text-sm">
        <input type="checkbox" class="h-4 w-4" name="consent" form="aa-form" checked={item.consent} />
        <span>Consentement obtenu</span>
      </label>
      <label class="mt-4 grid gap-2 text-sm">
        <span class="font-semibold text-ink/80">Date du consentement</span>
        <input class="cms-input" type="date" name="consent_date" form="aa-form" value={item.consent_date ?? ''} />
      </label>
      <label class="mt-4 grid gap-2 text-sm">
        <span class="font-semibold text-ink/80">Référence interne</span>
        <input class="cms-input" placeholder="Ref dossier" name="internal_ref" form="aa-form" value={item.internal_ref ?? ''} />
      </label>

      <div class="mt-6 space-y-3">
        <button
          type="submit"
          value="draft"
          name="intent"
          form="aa-form"
          data-submit
          class="btn btn-pill btn-md btn-primary w-full disabled:cursor-not-allowed disabled:opacity-60"
        >
          Enregistrer
        </button>
        <button
          type="submit"
          value="publish"
          name="intent"
          form="aa-form"
          data-submit
          class="btn btn-pill btn-md btn-secondary w-full disabled:cursor-not-allowed disabled:opacity-60"
        >
          Publier
        </button>
        <button
          type="button"
          data-delete
          class="btn btn-pill btn-md w-full border border-rose-200 bg-rose-50 text-rose-700 hover:bg-rose-100"
        >
          Supprimer le cas
        </button>
      </div>
      <div id="aa-status" class="mt-4 text-xs text-ink/60"></div>
      <div id="aa-error" class="mt-2 text-xs text-rose-600"></div>
    </aside>
  </div>
</CmsLayout>

<dialog id="aa-confirm" class="cms-drawer">
  <div class="cms-card-elevated mx-auto mt-28 w-[min(92vw,420px)] p-6">
    <div class="text-xs font-semibold uppercase tracking-wide text-ink/50">Suppression</div>
    <div class="mt-2 font-display text-2xl tracking-tight">Supprimer ce cas ?</div>
  <p class="mt-3 text-sm text-ink/70">Cette action est définitive et retire le cas du site.</p>
    <div class="mt-6 flex flex-wrap justify-end gap-3">
      <button type="button" data-cancel class="btn btn-pill btn-sm btn-secondary">Annuler</button>
      <button type="button" data-confirm class="btn btn-pill btn-sm btn-primary">Supprimer</button>
    </div>
  </div>
</dialog>

<script is:inline>
  (() => {
    const form = document.getElementById('aa-form');
    const error = document.getElementById('aa-error');
    const status = document.getElementById('aa-status');
    const submitButtons = document.querySelectorAll('[data-submit]');
    const deleteButton = document.querySelector('[data-delete]');
    const confirmDialog = document.getElementById('aa-confirm');
    const confirmBtn = confirmDialog?.querySelector('[data-confirm]');
    const cancelBtn = confirmDialog?.querySelector('[data-cancel]');
    const uploadState = { before: false, after: false };
    if (!(form instanceof HTMLFormElement)) return;

    const uploadInputs = form.querySelectorAll('[data-upload]');
    const setSubmitDisabled = (disabled) => {
      submitButtons.forEach((btn) => {
        if (btn instanceof HTMLButtonElement) btn.disabled = disabled;
      });
    };

    const setUploadState = (kind, isUploading, message = '') => {
      uploadState[kind] = isUploading;
      const statusEl = form.querySelector(`[data-upload-status="${kind}"]`);
      if (statusEl instanceof HTMLElement) statusEl.textContent = message;
      setSubmitDisabled(uploadState.before || uploadState.after);
    };

    uploadInputs.forEach((input) => {
      if (!(input instanceof HTMLInputElement)) return;
      input.addEventListener('change', async () => {
        const file = input.files?.[0];
        const kind = input.dataset.upload;
        if (!file || (kind !== 'before' && kind !== 'after')) return;
        const errorEl = form.querySelector(`[data-upload-error="${kind}"]`);
        if (errorEl instanceof HTMLElement) errorEl.textContent = '';
        if (file.size > 10 * 1024 * 1024) {
          if (errorEl instanceof HTMLElement) errorEl.textContent = 'Fichier trop lourd (10MB max).';
          input.value = '';
          return;
        }
        try {
          if (error) error.textContent = '';
          if (status) status.textContent = '';
          setUploadState(kind, true, 'Upload en cours...');
          const res = await fetch('/api/cms/avant-apres/upload-url', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ fileName: file.name, kind })
          });
          if (!res.ok) throw new Error('upload-url');
          const data = await res.json();
          const uploadRes = await fetch(data.signedUrl, {
            method: 'PUT',
            headers: { 'Content-Type': file.type },
            body: file
          });
          if (!uploadRes.ok) throw new Error('upload');

          const pathInput = form.querySelector(`[data-path="${kind}"]`);
          if (pathInput instanceof HTMLInputElement) pathInput.value = data.path;
          const preview = form.querySelector(`[data-preview="${kind}"]`);
          if (preview instanceof HTMLImageElement) preview.src = URL.createObjectURL(file);
          setUploadState(kind, false, 'Upload terminé.');
        } catch (err) {
          setUploadState(kind, false, '');
          if (errorEl instanceof HTMLElement) {
            errorEl.textContent = "Erreur d'upload. Vérifiez votre connexion.";
          }
        }
      });
    });

    form.addEventListener('submit', async (event) => {
      event.preventDefault();
      if (error) error.textContent = '';
      if (status) status.textContent = 'Enregistrement...';
      const submitter = event.submitter;
      const intent = submitter && submitter instanceof HTMLButtonElement ? submitter.value : 'draft';
      const formData = new FormData(form);
      const interventionSelect = form.querySelector('select[name="intervention_ref"]');
      const interventionLabel =
        interventionSelect instanceof HTMLSelectElement
          ? interventionSelect.selectedOptions[0]?.textContent?.trim() ?? ''
          : '';
      const payload = {
        title: interventionLabel || item.title,
        description: String(formData.get('description') ?? '').trim() || null,
        intervention_category: null,
        intervention_slug: null,
        consent: formData.get('consent') === 'on',
        consent_date: String(formData.get('consent_date') ?? '').trim() || null,
        internal_ref: String(formData.get('internal_ref') ?? '').trim() || null,
        before_path: String(formData.get('before_path') ?? '').trim(),
        after_path: String(formData.get('after_path') ?? '').trim(),
        status: intent === 'publish' ? 'publie' : 'brouillon'
      };

      const interventionRef = String(formData.get('intervention_ref') ?? '').trim();
      if (interventionRef) {
        const [cat, slug] = interventionRef.split('::');
        payload.intervention_category = cat || null;
        payload.intervention_slug = slug || null;
      }

      if (!interventionRef || !payload.title) {
        if (error) error.textContent = 'Sélectionnez une intervention associée.';
        if (status) status.textContent = '';
        return;
      }

      if (intent === 'publish' && !payload.consent) {
        if (error) error.textContent = 'Le consentement est requis pour publier.';
        if (status) status.textContent = '';
        return;
      }

      if (!payload.title || !payload.before_path || !payload.after_path) {
        if (error) error.textContent = 'Intervention et photos avant/après obligatoires.';
        if (status) status.textContent = '';
        return;
      }

      try {
        const caseId = form.dataset.id ?? '';
        const res = await fetch(`/api/cms/avant-apres/${encodeURIComponent(caseId)}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        if (!res.ok) throw new Error('save');
        if (status) status.textContent = 'Enregistré.';
        if (intent === 'publish') {
          window.location.href = '/cms/avant-apres?published=1';
          return;
        }
      } catch (err) {
        if (error) error.textContent = 'Erreur de sauvegarde.';
        if (status) status.textContent = '';
      }
    });

    if (deleteButton instanceof HTMLButtonElement) {
      deleteButton.addEventListener('click', async () => {
        const caseId = form.dataset.id ?? '';
        if (!caseId) return;
        if (confirmDialog instanceof HTMLDialogElement) confirmDialog.showModal();
      });
    }

    if (confirmDialog instanceof HTMLDialogElement) {
      const close = () => confirmDialog.close();
      if (cancelBtn instanceof HTMLElement) cancelBtn.addEventListener('click', close);
      confirmDialog.addEventListener('click', (event) => {
        if (event.target === confirmDialog) close();
      });
    }

    if (confirmBtn instanceof HTMLButtonElement) {
      confirmBtn.addEventListener('click', async () => {
        const caseId = form.dataset.id ?? '';
        if (!caseId) return;
        if (error) error.textContent = '';
        if (status) status.textContent = 'Suppression...';
        try {
          const res = await fetch(`/api/cms/avant-apres/${encodeURIComponent(caseId)}`, {
            method: 'DELETE'
          });
          if (!res.ok) throw new Error('delete');
          window.location.href = '/cms/avant-apres?deleted=1';
        } catch (err) {
          if (error) error.textContent = 'Erreur de suppression.';
          if (status) status.textContent = '';
        } finally {
          if (confirmDialog instanceof HTMLDialogElement) confirmDialog.close();
        }
      });
    }
  })();
</script>
