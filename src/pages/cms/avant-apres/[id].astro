---
import CmsLayout from '@/layouts/CmsLayout.astro';
import { getCmsAvantApresCase } from '@/lib/cms/avantApres';

Astro.response.headers.set('Cache-Control', 'no-store');
const { id } = Astro.params;
const item = id ? await getCmsAvantApresCase(id) : null;
if (!item) {
  return Astro.redirect('/cms/avant-apres');
}
---

<CmsLayout title="Edition cas">
  <div class="grid gap-6 lg:grid-cols-[minmax(0,1fr)_320px]">
    <section class="cms-card p-7">
      <div class="text-xs font-semibold uppercase tracking-wide text-ink/50">Avant/Apres</div>
      <h1 class="mt-2 font-display text-3xl tracking-tight">{item.title}</h1>

      <form id="aa-form" class="mt-8 grid gap-5" data-id={item.id}>
        <label class="grid gap-2 text-sm">
          <span class="font-semibold text-ink/80">Titre</span>
          <input class="cms-input" name="title" value={item.title} required />
        </label>
        <label class="grid gap-2 text-sm">
          <span class="font-semibold text-ink/80">Description courte</span>
          <textarea rows={3} class="cms-textarea" name="description">{item.description ?? ''}</textarea>
        </label>
        <label class="grid gap-2 text-sm">
          <span class="font-semibold text-ink/80">Zone</span>
          <input class="cms-input" name="zone" value={item.zone ?? ''} />
        </label>

        <div class="grid gap-4 sm:grid-cols-2">
          <div class="rounded-2xl border border-ink/10 bg-mist p-4">
            <div class="text-xs font-semibold uppercase tracking-wide text-ink/50">Avant</div>
            <img data-preview="before" src={item.beforeUrl} alt="Avant" class="mt-3 h-32 w-full rounded-xl object-cover" />
            <input type="file" accept="image/*" class="mt-3 block text-xs" data-upload="before" />
            <div class="mt-2 text-[11px] text-ink/50">JPG/PNG, 10MB max.</div>
            <div data-upload-status="before" class="mt-1 text-[11px] text-ink/60"></div>
            <div data-upload-error="before" class="mt-1 text-[11px] text-rose-600"></div>
            <input type="hidden" name="before_path" data-path="before" value={item.before_path} />
          </div>
          <div class="rounded-2xl border border-ink/10 bg-mist p-4">
            <div class="text-xs font-semibold uppercase tracking-wide text-ink/50">Apres</div>
            <img data-preview="after" src={item.afterUrl} alt="Apres" class="mt-3 h-32 w-full rounded-xl object-cover" />
            <input type="file" accept="image/*" class="mt-3 block text-xs" data-upload="after" />
            <div class="mt-2 text-[11px] text-ink/50">JPG/PNG, 10MB max.</div>
            <div data-upload-status="after" class="mt-1 text-[11px] text-ink/60"></div>
            <div data-upload-error="after" class="mt-1 text-[11px] text-rose-600"></div>
            <input type="hidden" name="after_path" data-path="after" value={item.after_path} />
          </div>
        </div>

        <label class="grid gap-2 text-sm">
          <span class="font-semibold text-ink/80">Caption</span>
          <input class="cms-input" name="caption" value={item.caption ?? ''} placeholder="Resultat a 6 mois" />
        </label>
      </form>
    </section>

    <aside class="cms-panel p-6">
      <div class="text-xs font-semibold uppercase tracking-wide text-ink/50">Consentement</div>
      <label class="mt-3 flex items-center gap-2 text-sm">
        <input type="checkbox" class="h-4 w-4" name="consent" form="aa-form" checked={item.consent} />
        <span>Consentement obtenu</span>
      </label>
      <label class="mt-4 grid gap-2 text-sm">
        <span class="font-semibold text-ink/80">Date du consentement</span>
        <input class="cms-input" type="date" name="consent_date" form="aa-form" value={item.consent_date ?? ''} />
      </label>
      <label class="mt-4 grid gap-2 text-sm">
        <span class="font-semibold text-ink/80">Reference interne</span>
        <input class="cms-input" placeholder="Ref dossier" name="internal_ref" form="aa-form" value={item.internal_ref ?? ''} />
      </label>

      <div class="mt-6 space-y-3">
        <button
          type="submit"
          value="draft"
          name="intent"
          form="aa-form"
          data-submit
          class="btn btn-pill btn-md btn-primary w-full disabled:cursor-not-allowed disabled:opacity-60"
        >
          Enregistrer
        </button>
        <button
          type="submit"
          value="publish"
          name="intent"
          form="aa-form"
          data-submit
          class="btn btn-pill btn-md btn-secondary w-full disabled:cursor-not-allowed disabled:opacity-60"
        >
          Publier
        </button>
        <button
          type="button"
          data-delete
          class="btn btn-pill btn-md w-full border border-rose-200 bg-rose-50 text-rose-700 hover:bg-rose-100"
        >
          Supprimer le cas
        </button>
      </div>
      <div id="aa-status" class="mt-4 text-xs text-ink/60"></div>
      <div id="aa-error" class="mt-2 text-xs text-rose-600"></div>
    </aside>
  </div>
</CmsLayout>

<script is:inline>
  (() => {
    const form = document.getElementById('aa-form');
    const error = document.getElementById('aa-error');
    const status = document.getElementById('aa-status');
    const submitButtons = document.querySelectorAll('[data-submit]');
    const deleteButton = document.querySelector('[data-delete]');
    const uploadState = { before: false, after: false };
    if (!(form instanceof HTMLFormElement)) return;

    const uploadInputs = form.querySelectorAll('[data-upload]');
    const setSubmitDisabled = (disabled) => {
      submitButtons.forEach((btn) => {
        if (btn instanceof HTMLButtonElement) btn.disabled = disabled;
      });
    };

    const setUploadState = (kind, isUploading, message = '') => {
      uploadState[kind] = isUploading;
      const statusEl = form.querySelector(`[data-upload-status="${kind}"]`);
      if (statusEl instanceof HTMLElement) statusEl.textContent = message;
      setSubmitDisabled(uploadState.before || uploadState.after);
    };

    uploadInputs.forEach((input) => {
      if (!(input instanceof HTMLInputElement)) return;
      input.addEventListener('change', async () => {
        const file = input.files?.[0];
        const kind = input.dataset.upload;
        if (!file || (kind !== 'before' && kind !== 'after')) return;
        const errorEl = form.querySelector(`[data-upload-error="${kind}"]`);
        if (errorEl instanceof HTMLElement) errorEl.textContent = '';
        if (file.size > 10 * 1024 * 1024) {
          if (errorEl instanceof HTMLElement) errorEl.textContent = 'Fichier trop lourd (10MB max).';
          input.value = '';
          return;
        }
        try {
          if (error) error.textContent = '';
          if (status) status.textContent = '';
          setUploadState(kind, true, 'Upload en cours...');
          const res = await fetch('/api/cms/avant-apres/upload-url', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ fileName: file.name, kind })
          });
          if (!res.ok) throw new Error('upload-url');
          const data = await res.json();
          const uploadRes = await fetch(data.signedUrl, {
            method: 'PUT',
            headers: { 'Content-Type': file.type },
            body: file
          });
          if (!uploadRes.ok) throw new Error('upload');

          const pathInput = form.querySelector(`[data-path="${kind}"]`);
          if (pathInput instanceof HTMLInputElement) pathInput.value = data.path;
          const preview = form.querySelector(`[data-preview="${kind}"]`);
          if (preview instanceof HTMLImageElement) preview.src = URL.createObjectURL(file);
          setUploadState(kind, false, 'Upload termine.');
        } catch (err) {
          setUploadState(kind, false, '');
          if (errorEl instanceof HTMLElement) {
            errorEl.textContent = "Erreur d'upload. Verifiez votre connexion.";
          }
        }
      });
    });

    form.addEventListener('submit', async (event) => {
      event.preventDefault();
      if (error) error.textContent = '';
      if (status) status.textContent = 'Enregistrement...';
      const submitter = event.submitter;
      const intent = submitter && submitter instanceof HTMLButtonElement ? submitter.value : 'draft';
      const formData = new FormData(form);
      const payload = {
        title: String(formData.get('title') ?? '').trim(),
        description: String(formData.get('description') ?? '').trim() || null,
        zone: String(formData.get('zone') ?? '').trim() || null,
        caption: String(formData.get('caption') ?? '').trim() || null,
        consent: formData.get('consent') === 'on',
        consent_date: String(formData.get('consent_date') ?? '').trim() || null,
        internal_ref: String(formData.get('internal_ref') ?? '').trim() || null,
        before_path: String(formData.get('before_path') ?? '').trim(),
        after_path: String(formData.get('after_path') ?? '').trim(),
        status: intent === 'publish' ? 'publie' : 'brouillon'
      };

      if (intent === 'publish' && !payload.consent) {
        if (error) error.textContent = 'Le consentement est requis pour publier.';
        if (status) status.textContent = '';
        return;
      }

      if (!payload.title || !payload.before_path || !payload.after_path) {
        if (error) error.textContent = 'Titre et photos avant/apres obligatoires.';
        if (status) status.textContent = '';
        return;
      }

      try {
        const caseId = form.dataset.id ?? '';
        const res = await fetch(`/api/cms/avant-apres/${encodeURIComponent(caseId)}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        if (!res.ok) throw new Error('save');
        if (status) status.textContent = 'Enregistre.';
        if (intent === 'publish') {
          window.location.href = '/cms/avant-apres?published=1';
          return;
        }
      } catch (err) {
        if (error) error.textContent = 'Erreur de sauvegarde.';
        if (status) status.textContent = '';
      }
    });

    if (deleteButton instanceof HTMLButtonElement) {
      deleteButton.addEventListener('click', async () => {
        const caseId = form.dataset.id ?? '';
        if (!caseId) return;
        const confirmed = window.confirm('Supprimer ce cas ? Cette action est definitive.');
        if (!confirmed) return;
        if (error) error.textContent = '';
        if (status) status.textContent = 'Suppression...';
        try {
          const res = await fetch(`/api/cms/avant-apres/${encodeURIComponent(caseId)}`, {
            method: 'DELETE'
          });
          if (!res.ok) throw new Error('delete');
          window.location.href = '/cms/avant-apres?deleted=1';
        } catch (err) {
          if (error) error.textContent = 'Erreur de suppression.';
          if (status) status.textContent = '';
        }
      });
    }
  })();
</script>
