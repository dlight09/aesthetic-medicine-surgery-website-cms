---
import CmsLayout from '@/layouts/CmsLayout.astro';
import { listCmsAvantApresCases, type AvantApresCaseView } from '@/lib/cms/avantApres';

Astro.response.headers.set('Cache-Control', 'no-store');
const statusClass = (status: 'publie' | 'brouillon') =>
  status === 'publie' ? 'bg-emerald-100 text-emerald-700' : 'bg-ink/10 text-ink/70';

const items = (await listCmsAvantApresCases()) as AvantApresCaseView[];
const zones = Array.from(new Set(items.map((item) => item.zone).filter(Boolean))) as string[];
const formatDate = (value: string) =>
  new Date(value).toLocaleDateString('fr-FR', { day: '2-digit', month: '2-digit', year: 'numeric' });
---

<CmsLayout title="Avant/Apres">
  <div class="space-y-6">
    <div id="aa-toast" class="hidden rounded-2xl border border-emerald-200 bg-emerald-50 px-4 py-3 text-sm text-emerald-800">
      Cas publie avec succes.
    </div>
    <div id="aa-toast-delete" class="hidden rounded-2xl border border-rose-200 bg-rose-50 px-4 py-3 text-sm text-rose-700">
      Cas supprime.
    </div>
    <div id="aa-toast-error" class="hidden rounded-2xl border border-rose-200 bg-rose-50 px-4 py-3 text-sm text-rose-700">
      Erreur de suppression.
    </div>
    <div class="flex flex-wrap items-center justify-between gap-3">
      <div>
        <div class="text-xs font-semibold uppercase tracking-wide text-ink/50">Cas</div>
        <h1 class="mt-1 font-display text-3xl tracking-tight">Avant/Apres</h1>
      </div>
      <a href="/cms/avant-apres/new" class="btn btn-pill btn-sm btn-primary">Nouveau cas</a>
    </div>

    <div class="cms-card p-6">
      <div class="grid gap-3 md:grid-cols-[1.2fr_0.7fr_0.7fr_0.6fr]">
        <label class="grid gap-2 text-sm">
          <span class="font-semibold text-ink/70">Recherche</span>
          <input id="aa-search" class="cms-input" placeholder="Titre, zone..." />
        </label>
        <label class="grid gap-2 text-sm">
          <span class="font-semibold text-ink/70">Statut</span>
          <select id="aa-status" class="cms-select">
            <option value="">Tous</option>
            <option value="publie">Publie</option>
            <option value="brouillon">Brouillon</option>
          </select>
        </label>
        <label class="grid gap-2 text-sm">
          <span class="font-semibold text-ink/70">Consentement</span>
          <select id="aa-consent" class="cms-select">
            <option value="">Tous</option>
            <option value="true">Consent OK</option>
            <option value="false">Sans consentement</option>
          </select>
        </label>
        <label class="grid gap-2 text-sm">
          <span class="font-semibold text-ink/70">Zone</span>
          <select id="aa-zone" class="cms-select">
            <option value="">Toutes</option>
            {zones.map((zone) => (
              <option value={zone}>{zone}</option>
            ))}
          </select>
        </label>
      </div>
    </div>

    <div class="cms-card shadow-soft">
      <div class="grid grid-cols-[1.4fr_0.8fr_0.8fr_0.6fr_0.4fr] gap-4 border-b border-ink/10 px-6 py-4 text-xs font-semibold uppercase tracking-wide text-ink/50">
        <div>Cas</div>
        <div>Zone</div>
        <div>Consentement</div>
        <div>Statut</div>
        <div>Actions</div>
      </div>
      <div id="aa-list" class="divide-y divide-ink/5">
        {items.map((item) => (
          <div
            class="cms-row grid grid-cols-[1.4fr_0.8fr_0.8fr_0.6fr_0.4fr] gap-4 px-6 py-4 text-sm"
            data-row
            data-href={`/cms/avant-apres/${item.id}`}
            data-id={item.id}
            data-title={item.title.toLowerCase()}
            data-zone={(item.zone ?? '').toLowerCase()}
            data-status={item.status}
            data-consent={item.consent ? 'true' : 'false'}
          >
            <div class="flex items-center gap-3">
              <div class="flex gap-2">
                <img src={item.beforeUrl} alt="Avant" class="h-10 w-14 rounded-lg object-cover" />
                <img src={item.afterUrl} alt="Apres" class="h-10 w-14 rounded-lg object-cover" />
              </div>
              <div>
                <a href={`/cms/avant-apres/${item.id}`} class="font-semibold text-ink/90 hover:text-ink">
                  {item.title}
                </a>
                <div class="text-xs text-ink/60">MAJ: {formatDate(item.updated_at)}</div>
              </div>
            </div>
            <div class="text-ink/70">{item.zone ?? 'â€”'}</div>
            <div>
              <span class:list={[
                'cms-pill',
                item.consent ? 'bg-emerald-100 text-emerald-700' : 'bg-rose-100 text-rose-700'
              ]}>
                {item.consent ? 'Consent OK' : 'Sans consentement'}
              </span>
            </div>
            <div>
              <span class:list={['cms-pill', statusClass(item.status)]}>
                {item.status === 'publie' ? 'Publie' : 'Brouillon'}
              </span>
            </div>
            <div>
              <button
                type="button"
                data-delete-row
                class="rounded-full border border-rose-200 bg-rose-50 px-3 py-1 text-xs font-semibold text-rose-700 hover:bg-rose-100"
              >
                Supprimer
              </button>
            </div>
          </div>
        ))}
      </div>
    </div>
  </div>
</CmsLayout>

<script is:inline>
  (() => {
    const toast = document.getElementById('aa-toast');
    const params = new URLSearchParams(window.location.search);
    if (toast instanceof HTMLElement && params.get('published') === '1') {
      toast.classList.remove('hidden');
      window.history.replaceState({}, '', window.location.pathname);
      setTimeout(() => toast.classList.add('hidden'), 3200);
    }

    const deleteToast = document.getElementById('aa-toast-delete');
    const errorToast = document.getElementById('aa-toast-error');
    if (deleteToast instanceof HTMLElement && params.get('deleted') === '1') {
      deleteToast.classList.remove('hidden');
      window.history.replaceState({}, '', window.location.pathname);
      setTimeout(() => deleteToast.classList.add('hidden'), 3200);
    }

    const list = document.getElementById('aa-list');
    const search = document.getElementById('aa-search');
    const status = document.getElementById('aa-status');
    const consent = document.getElementById('aa-consent');
    const zone = document.getElementById('aa-zone');
    if (!(list instanceof HTMLElement)) return;

    list.addEventListener('click', async (event) => {
      const target = event.target instanceof HTMLElement ? event.target : null;
      if (!target) return;
      const deleteBtn = target.closest('[data-delete-row]');
      if (!deleteBtn) {
        const row = target.closest('[data-row]');
        if (row instanceof HTMLElement) {
          const href = row.dataset.href;
          if (href) window.location.href = href;
        }
        return;
      }
      const row = target.closest('[data-row]');
      if (!(row instanceof HTMLElement)) return;
      const caseId = row.dataset.id ?? '';
      if (!caseId) return;
      const confirmed = window.confirm('Supprimer ce cas ? Cette action est definitive.');
      if (!confirmed) return;
      try {
        const res = await fetch(`/api/cms/avant-apres/${encodeURIComponent(caseId)}`, { method: 'DELETE' });
        if (!res.ok) throw new Error('delete');
        row.remove();
        if (deleteToast instanceof HTMLElement) {
          deleteToast.classList.remove('hidden');
          setTimeout(() => deleteToast.classList.add('hidden'), 3200);
        }
      } catch (err) {
        if (errorToast instanceof HTMLElement) {
          errorToast.classList.remove('hidden');
          setTimeout(() => errorToast.classList.add('hidden'), 3200);
        }
      }
    });

    const apply = () => {
      const q = search instanceof HTMLInputElement ? search.value.trim().toLowerCase() : '';
      const st = status instanceof HTMLSelectElement ? status.value : '';
      const co = consent instanceof HTMLSelectElement ? consent.value : '';
      const zo = zone instanceof HTMLSelectElement ? zone.value.toLowerCase() : '';
      const rows = list.querySelectorAll('[data-row]');
      rows.forEach((row) => {
        if (!(row instanceof HTMLElement)) return;
        const title = row.dataset.title ?? '';
        const rZone = row.dataset.zone ?? '';
        const rStatus = row.dataset.status ?? '';
        const rConsent = row.dataset.consent ?? '';
        const matchesQuery = !q || title.includes(q) || rZone.includes(q);
        const matchesStatus = !st || rStatus === st;
        const matchesConsent = !co || rConsent === co;
        const matchesZone = !zo || rZone === zo;
        row.style.display = matchesQuery && matchesStatus && matchesConsent && matchesZone ? '' : 'none';
      });
    };

    [search, status, consent, zone].forEach((el) => {
      if (el) el.addEventListener('input', apply);
    });
  })();
</script>
