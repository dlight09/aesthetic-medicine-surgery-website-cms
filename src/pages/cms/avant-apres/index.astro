---
import CmsLayout from '@/layouts/CmsLayout.astro';
import { listCmsAvantApresCases, type AvantApresCaseView } from '@/lib/cms/avantApres';
import { getCollection } from 'astro:content';
import { interventionCategories } from '@/lib/interventions';

Astro.response.headers.set('Cache-Control', 'no-store');
const statusClass = (status: 'publie' | 'brouillon') =>
  status === 'publie' ? 'bg-emerald-100 text-emerald-700' : 'bg-ink/10 text-ink/70';

type AvantApresCaseWithIntervention = AvantApresCaseView & {
  intervention_category?: string | null;
  intervention_slug?: string | null;
  description?: string | null;
  case_number?: number | null;
};
const items = (await listCmsAvantApresCases()) as AvantApresCaseWithIntervention[];
const interventions = await getCollection('interventions');
const interventionsByCategory = interventionCategories.map((category) => {
  const entries = interventions
    .filter((entry) => entry.data.category === category.key)
    .sort((a, b) => (a.data.order ?? 999) - (b.data.order ?? 999))
    .map((entry) => ({
      title: entry.data.title,
      slug: entry.slug.split('/').filter(Boolean).slice(-1)[0] ?? entry.slug,
      category: entry.data.category,
    }));
  return { ...category, entries };
});
const interventionTitleByRef = new Map(
  interventions.map((entry) => {
    const slug = entry.slug.split('/').filter(Boolean).slice(-1)[0] ?? entry.slug;
    return [`${entry.data.category}::${slug}`, entry.data.title];
  }),
);
const formatDate = (value: string) =>
  new Date(value).toLocaleDateString('fr-FR', { day: '2-digit', month: '2-digit', year: 'numeric' });
const formatCaseNumber = (value?: number | null) =>
  value ? `Cas ${String(value).padStart(2, '0')}` : '—';

const casesByRef = new Map<string, AvantApresCaseWithIntervention[]>();
const unassignedCases = items.filter((item) => !item.intervention_category || !item.intervention_slug);
items.forEach((item) => {
  if (!item.intervention_category || !item.intervention_slug) return;
  const ref = `${item.intervention_category}::${item.intervention_slug}`;
  const list = casesByRef.get(ref) ?? [];
  list.push(item);
  casesByRef.set(ref, list);
});
casesByRef.forEach((list, key) => {
  casesByRef.set(
    key,
    list.sort((a, b) => (a.case_number ?? 999) - (b.case_number ?? 999)),
  );
});

const categorySections = interventionsByCategory
  .map((category) => {
    const interventionsWithCases = category.entries
      .map((entry) => {
        const ref = `${entry.category}::${entry.slug}`;
        const cases = casesByRef.get(ref) ?? [];
        return { ...entry, ref, cases };
      })
      .filter((entry) => entry.cases.length > 0);
    return {
      ...category,
      interventions: interventionsWithCases,
      caseCount: interventionsWithCases.reduce((sum, entry) => sum + entry.cases.length, 0),
    };
  })
  .filter((category) => category.interventions.length > 0);

const interventionOptionsByCategory = new Map(
  categorySections.map((category) => [
    category.key,
    category.interventions.map((intervention) => ({
      label: intervention.title,
      ref: intervention.ref,
    })),
  ]),
);
---

<CmsLayout title="Avant/Après">
  <div class="space-y-6">
    <div id="aa-toast" class="hidden rounded-2xl border border-emerald-200 bg-emerald-50 px-4 py-3 text-sm text-emerald-800">
      Cas publié avec succès.
    </div>
    <div id="aa-toast-delete" class="hidden rounded-2xl border border-rose-200 bg-rose-50 px-4 py-3 text-sm text-rose-700">
      Cas supprimé.
    </div>
    <div id="aa-toast-error" class="hidden rounded-2xl border border-rose-200 bg-rose-50 px-4 py-3 text-sm text-rose-700">
      Erreur de suppression.
    </div>
    <dialog id="aa-confirm" class="cms-drawer">
      <div class="cms-card-elevated mx-auto mt-28 w-[min(92vw,420px)] p-6">
        <div class="text-xs font-semibold uppercase tracking-wide text-ink/50">Suppression</div>
        <div class="mt-2 font-display text-2xl tracking-tight">Supprimer ce cas ?</div>
        <p class="mt-3 text-sm text-ink/70">Cette action est définitive et retire le cas du site.</p>
        <div class="mt-6 flex flex-wrap justify-end gap-3">
          <button type="button" data-cancel class="btn btn-pill btn-sm btn-secondary">Annuler</button>
          <button type="button" data-confirm class="btn btn-pill btn-sm btn-primary">Supprimer</button>
        </div>
      </div>
    </dialog>
    <div class="flex flex-wrap items-center justify-between gap-3">
      <div>
        <div class="text-xs font-semibold uppercase tracking-wide text-ink/50">Cas</div>
        <h1 class="mt-1 font-display text-3xl tracking-tight">Avant/Après</h1>
      </div>
      <a href="/cms/avant-apres/new" class="btn btn-pill btn-sm btn-primary">Nouveau cas</a>
    </div>

    <div class="cms-card p-6">
      <div class="grid gap-3 md:grid-cols-[1.2fr_0.7fr_0.9fr_0.7fr_0.7fr]">
        <label class="grid gap-2 text-sm">
          <span class="font-semibold text-ink/70">Recherche</span>
          <div class="relative">
            <input
              id="aa-search"
              class="cms-input w-full pr-9"
              placeholder="Cas 01, intervention, description..."
            />
            <button
              type="button"
              id="aa-clear"
              class="absolute right-3 top-1/2 -translate-y-1/2 text-xs text-ink/40 hover:text-ink"
              aria-label="Réinitialiser la recherche"
            >
              ✕
            </button>
          </div>
          <div class="text-xs text-ink/50">Astuce: #02 ou cas:02 pour un numéro.</div>
        </label>
        <label class="grid gap-2 text-sm">
          <span class="font-semibold text-ink/70">Catégorie</span>
          <select id="aa-category" class="cms-select">
            <option value="">Toutes</option>
            {categorySections.map((category) => (
              <option value={category.key}>{category.title}</option>
            ))}
          </select>
        </label>
        <label class="grid gap-2 text-sm">
          <span class="font-semibold text-ink/70">Intervention</span>
          <select id="aa-intervention" class="cms-select">
            <option value="">Toutes</option>
            {categorySections.flatMap((category) =>
              category.interventions.map((intervention) => (
                <option value={intervention.ref}>{intervention.title}</option>
              )),
            )}
          </select>
        </label>
        <label class="grid gap-2 text-sm">
          <span class="font-semibold text-ink/70">Statut</span>
          <select id="aa-status" class="cms-select">
            <option value="">Tous</option>
            <option value="publie">Publié</option>
            <option value="brouillon">Brouillon</option>
          </select>
        </label>
        <label class="grid gap-2 text-sm">
          <span class="font-semibold text-ink/70">Consentement</span>
          <select id="aa-consent" class="cms-select">
            <option value="">Tous</option>
            <option value="true">Consent OK</option>
            <option value="false">Sans consentement</option>
          </select>
        </label>
      </div>
      <div class="mt-4 flex flex-wrap items-center justify-between gap-3 text-sm text-ink/60">
        <div id="aa-count">—</div>
        <button type="button" id="aa-reset" class="text-sm font-semibold text-ink/70 hover:text-ink">
          Réinitialiser
        </button>
      </div>
    </div>

    <div id="aa-intervention-options" class="hidden" aria-hidden="true">
      {JSON.stringify(Array.from(interventionOptionsByCategory.entries()))}
    </div>
    <div id="aa-list" class="space-y-8">
      {categorySections.length ? (
        categorySections.map((category) => (
          <section class="cms-card p-6" data-category-group data-category-key={category.key}>
            <div class="flex flex-wrap items-start justify-between gap-3">
              <div>
                <div class="text-xs font-semibold uppercase tracking-wide text-ink/50">Catégorie</div>
                <h2 class="mt-2 font-display text-2xl tracking-tight">{category.title}</h2>
                <div class="mt-1 text-sm text-ink/60">{category.description}</div>
              </div>
              <div class="text-sm text-ink/60">{category.caseCount} cas</div>
            </div>

            <div class="mt-6 space-y-6">
              {category.interventions.map((intervention) => (
                <div class="rounded-3xl border border-ink/10 bg-mist/40 p-5" data-intervention-group>
                  <div class="flex flex-wrap items-center justify-between gap-3">
                    <div>
                      <div class="text-sm font-semibold text-ink/85">{intervention.title}</div>
                      <div class="text-xs text-ink/60">{intervention.cases.length} cas</div>
                    </div>
                    <a
                      href={`/cms/avant-apres/new?intervention_ref=${intervention.ref}`}
                      class="btn btn-pill btn-sm btn-secondary"
                    >
                      Ajouter un cas
                    </a>
                  </div>

                  <div class="mt-4 space-y-3">
                    {intervention.cases.map((item) => (
                      <div
                        class="cms-row flex flex-wrap items-center justify-between gap-4 rounded-2xl border border-ink/10 bg-paper px-4 py-3 text-sm"
                        data-row
                        data-href={`/cms/avant-apres/${item.id}`}
                        data-id={item.id}
                        data-title={item.title.toLowerCase()}
                        data-status={item.status}
                        data-consent={item.consent ? 'true' : 'false'}
                        data-intervention={intervention.ref}
                        data-intervention-label={intervention.title.toLowerCase()}
                        data-description={(item.description ?? '').toLowerCase()}
                        data-case-number={item.case_number ?? ''}
                      >
                        <div class="flex items-center gap-3">
                          <div class="flex gap-2">
                            <img src={item.beforeUrl} alt="Avant" class="h-10 w-14 rounded-lg object-cover" />
                            <img src={item.afterUrl} alt="Après" class="h-10 w-14 rounded-lg object-cover" />
                          </div>
                          <div>
                            <div class="font-semibold text-ink/90">{formatCaseNumber(item.case_number)}</div>
                            <div class="text-xs text-ink/60">MAJ: {formatDate(item.updated_at)}</div>
                            {item.description ? (
                              <div class="text-xs text-ink/50">{item.description}</div>
                            ) : null}
                          </div>
                        </div>
                        <div class="flex flex-wrap items-center gap-2">
                          <span class:list={[
                            'cms-pill',
                            item.consent ? 'bg-emerald-100 text-emerald-700' : 'bg-rose-100 text-rose-700'
                          ]}>
                            {item.consent ? 'Consent OK' : 'Sans consentement'}
                          </span>
                          <span class:list={['cms-pill', statusClass(item.status)]}>
                            {item.status === 'publie' ? 'Publié' : 'Brouillon'}
                          </span>
                          <button
                            type="button"
                            data-delete-row
                            class="rounded-full border border-rose-200 bg-rose-50 px-3 py-1 text-xs font-semibold text-rose-700 hover:bg-rose-100"
                          >
                            Supprimer
                          </button>
                        </div>
                      </div>
                    ))}
                  </div>
                </div>
              ))}
            </div>
          </section>
        ))
      ) : (
        <div class="cms-card p-8 text-sm text-ink/70">Aucun cas pour le moment.</div>
      )}

      {unassignedCases.length ? (
        <section class="cms-card p-6" data-category-group>
          <div class="text-xs font-semibold uppercase tracking-wide text-ink/50">Non classé</div>
          <div class="mt-2 font-display text-2xl tracking-tight">Cas sans intervention</div>
          <div class="mt-4 space-y-3">
            {unassignedCases.map((item) => (
              <div
                class="cms-row flex flex-wrap items-center justify-between gap-4 rounded-2xl border border-ink/10 bg-paper px-4 py-3 text-sm"
                data-row
                data-href={`/cms/avant-apres/${item.id}`}
                data-id={item.id}
                data-title={item.title.toLowerCase()}
                data-status={item.status}
                data-consent={item.consent ? 'true' : 'false'}
                data-intervention=""
                data-description={(item.description ?? '').toLowerCase()}
                data-case-number={item.case_number ?? ''}
              >
                <div class="flex items-center gap-3">
                  <div class="flex gap-2">
                    <img src={item.beforeUrl} alt="Avant" class="h-10 w-14 rounded-lg object-cover" />
                    <img src={item.afterUrl} alt="Après" class="h-10 w-14 rounded-lg object-cover" />
                  </div>
                  <div>
                    <div class="font-semibold text-ink/90">{formatCaseNumber(item.case_number)}</div>
                    <div class="text-xs text-ink/60">MAJ: {formatDate(item.updated_at)}</div>
                  </div>
                </div>
                <div class="flex flex-wrap items-center gap-2">
                  <span class:list={[
                    'cms-pill',
                    item.consent ? 'bg-emerald-100 text-emerald-700' : 'bg-rose-100 text-rose-700'
                  ]}>
                    {item.consent ? 'Consent OK' : 'Sans consentement'}
                  </span>
                  <span class:list={['cms-pill', statusClass(item.status)]}>
                    {item.status === 'publie' ? 'Publié' : 'Brouillon'}
                  </span>
                  <button
                    type="button"
                    data-delete-row
                    class="rounded-full border border-rose-200 bg-rose-50 px-3 py-1 text-xs font-semibold text-rose-700 hover:bg-rose-100"
                  >
                    Supprimer
                  </button>
                </div>
              </div>
            ))}
          </div>
        </section>
      ) : null}
    </div>
  </div>
</CmsLayout>

<script is:inline>
  (() => {
    const toast = document.getElementById('aa-toast');
    const params = new URLSearchParams(window.location.search);
    if (toast instanceof HTMLElement && params.get('published') === '1') {
      toast.classList.remove('hidden');
      window.history.replaceState({}, '', window.location.pathname);
      setTimeout(() => toast.classList.add('hidden'), 3200);
    }

    const deleteToast = document.getElementById('aa-toast-delete');
    const errorToast = document.getElementById('aa-toast-error');
    const confirmDialog = document.getElementById('aa-confirm');
    const confirmBtn = confirmDialog?.querySelector('[data-confirm]');
    const cancelBtn = confirmDialog?.querySelector('[data-cancel]');
    let pendingDeleteId = '';
    if (deleteToast instanceof HTMLElement && params.get('deleted') === '1') {
      deleteToast.classList.remove('hidden');
      window.history.replaceState({}, '', window.location.pathname);
      setTimeout(() => deleteToast.classList.add('hidden'), 3200);
    }

    const list = document.getElementById('aa-list');
    const search = document.getElementById('aa-search');
    const clearBtn = document.getElementById('aa-clear');
    const status = document.getElementById('aa-status');
    const consent = document.getElementById('aa-consent');
    const category = document.getElementById('aa-category');
    const intervention = document.getElementById('aa-intervention');
    const resetBtn = document.getElementById('aa-reset');
    const counter = document.getElementById('aa-count');
    if (!(list instanceof HTMLElement)) return;

    const interventionOptionsByCategory = new Map(
      JSON.parse(document.getElementById('aa-intervention-options')?.textContent ?? '[]'),
    );

    const updateInterventionOptions = () => {
      if (!(intervention instanceof HTMLSelectElement)) return;
      const value = category instanceof HTMLSelectElement ? category.value : '';
      const current = intervention.value;
      const options = value ? interventionOptionsByCategory.get(value) ?? [] : null;
      const items = options ?? Array.from(interventionOptionsByCategory.values()).flat();
      intervention.innerHTML = '<option value="">Toutes</option>';
      items.forEach((item) => {
        const opt = document.createElement('option');
        opt.value = item.ref;
        opt.textContent = item.label;
        intervention.appendChild(opt);
      });
      if (current && items.some((item) => item.ref === current)) {
        intervention.value = current;
      }
    };

    const parseQuery = () => {
      const params = new URLSearchParams(window.location.search);
      return {
        q: params.get('q') ?? '',
        stat: params.get('statut') ?? '',
        consent: params.get('consent') ?? '',
        cat: params.get('cat') ?? '',
        ref: params.get('ref') ?? '',
      };
    };

    const setQuery = (next) => {
      const params = new URLSearchParams(window.location.search);
      ['q', 'statut', 'consent', 'cat', 'ref'].forEach((key) => params.delete(key));
      if (next.q) params.set('q', next.q);
      if (next.stat) params.set('statut', next.stat);
      if (next.consent) params.set('consent', next.consent);
      if (next.cat) params.set('cat', next.cat);
      if (next.ref) params.set('ref', next.ref);
      const query = params.toString();
      window.history.replaceState({}, '', query ? `?${query}` : window.location.pathname);
    };

    const setInitialState = () => {
      const query = parseQuery();
      if (search instanceof HTMLInputElement) search.value = query.q;
      if (status instanceof HTMLSelectElement) status.value = query.stat;
      if (consent instanceof HTMLSelectElement) consent.value = query.consent;
      if (category instanceof HTMLSelectElement) category.value = query.cat;
      updateInterventionOptions();
      if (intervention instanceof HTMLSelectElement) intervention.value = query.ref;
    };

    list.addEventListener('click', async (event) => {
      const target = event.target instanceof HTMLElement ? event.target : null;
      if (!target) return;
      const deleteBtn = target.closest('[data-delete-row]');
      if (!deleteBtn) {
        const row = target.closest('[data-row]');
        if (row instanceof HTMLElement) {
          const href = row.dataset.href;
          if (href) window.location.href = href;
        }
        return;
      }
      const row = target.closest('[data-row]');
      if (!(row instanceof HTMLElement)) return;
      const caseId = row.dataset.id ?? '';
      if (!caseId) return;
      pendingDeleteId = caseId;
      if (confirmDialog instanceof HTMLDialogElement) confirmDialog.showModal();
    });

    if (confirmDialog instanceof HTMLDialogElement) {
      const close = () => confirmDialog.close();
      if (cancelBtn instanceof HTMLElement) cancelBtn.addEventListener('click', close);
      confirmDialog.addEventListener('click', (event) => {
        if (event.target === confirmDialog) close();
      });
    }

    if (confirmBtn instanceof HTMLButtonElement) {
      confirmBtn.addEventListener('click', async () => {
        const caseId = pendingDeleteId;
        if (!caseId) return;
        try {
          const res = await fetch(`/api/cms/avant-apres/${encodeURIComponent(caseId)}`, { method: 'DELETE' });
          if (!res.ok) throw new Error('delete');
          const row = list.querySelector(`[data-row][data-id="${caseId}"]`);
          if (row instanceof HTMLElement) row.remove();
          apply();
          if (deleteToast instanceof HTMLElement) {
            deleteToast.classList.remove('hidden');
            setTimeout(() => deleteToast.classList.add('hidden'), 3200);
          }
        } catch (err) {
          if (errorToast instanceof HTMLElement) {
            errorToast.classList.remove('hidden');
            setTimeout(() => errorToast.classList.add('hidden'), 3200);
          }
        } finally {
          pendingDeleteId = '';
          if (confirmDialog instanceof HTMLDialogElement) confirmDialog.close();
        }
      });
    }

    const apply = () => {
      const qRaw = search instanceof HTMLInputElement ? search.value.trim() : '';
      const q = qRaw.toLowerCase();
      const st = status instanceof HTMLSelectElement ? status.value : '';
      const co = consent instanceof HTMLSelectElement ? consent.value : '';
      const cat = category instanceof HTMLSelectElement ? category.value : '';
      const ref = intervention instanceof HTMLSelectElement ? intervention.value : '';

      const matchNumber = (value) => {
        if (!value) return null;
        const casMatch = value.match(/(?:^|\s)(?:cas:|#)(\d+)/i);
        if (casMatch) return casMatch[1];
        return null;
      };

      const numberQuery = matchNumber(qRaw);
      const rows = list.querySelectorAll('[data-row]');
      let visibleCount = 0;
      rows.forEach((row) => {
        if (!(row instanceof HTMLElement)) return;
        const title = row.dataset.title ?? '';
        const rStatus = row.dataset.status ?? '';
        const rConsent = row.dataset.consent ?? '';
        const rIntervention = row.dataset.interventionLabel ?? '';
        const description = row.dataset.description ?? '';
        const caseNumber = row.dataset.caseNumber ?? '';
        const rowCat = row.closest('[data-category-group]')?.getAttribute('data-category-key') ?? '';
        const rowRef = row.dataset.intervention ?? '';
        const matchesQuery =
          !q ||
          title.includes(q) ||
          rIntervention.includes(q) ||
          description.includes(q) ||
          caseNumber.includes(q) ||
          (numberQuery ? caseNumber === numberQuery : false);
        const matchesStatus = !st || rStatus === st;
        const matchesConsent = !co || rConsent === co;
        const matchesCategory = !cat || rowCat === cat;
        const matchesIntervention = !ref || rowRef === ref;
        const visible = matchesQuery && matchesStatus && matchesConsent && matchesCategory && matchesIntervention;
        row.style.display = visible ? '' : 'none';
        if (visible) visibleCount += 1;
      });

      const interventionGroups = list.querySelectorAll('[data-intervention-group]');
      let visibleInterventions = 0;
      interventionGroups.forEach((group) => {
        if (!(group instanceof HTMLElement)) return;
        const visible = Array.from(group.querySelectorAll('[data-row]')).some(
          (row) => row instanceof HTMLElement && row.style.display !== 'none',
        );
        group.style.display = visible ? '' : 'none';
        if (visible) visibleInterventions += 1;
      });

      const categoryGroups = list.querySelectorAll('[data-category-group]');
      let visibleCategories = 0;
      categoryGroups.forEach((group) => {
        if (!(group instanceof HTMLElement)) return;
        const visible = Array.from(group.querySelectorAll('[data-intervention-group]')).some(
          (row) => row instanceof HTMLElement && row.style.display !== 'none',
        );
        group.style.display = visible ? '' : 'none';
        if (visible) visibleCategories += 1;
      });

      if (counter instanceof HTMLElement) {
        counter.textContent = `${visibleCount} cas • ${visibleInterventions} interventions • ${visibleCategories} catégories`;
      }

      setQuery({ q: qRaw, stat: st, consent: co, cat, ref });
    };

    const debounce = (fn, delay = 120) => {
      let t;
      return (...args) => {
        window.clearTimeout(t);
        t = window.setTimeout(() => fn(...args), delay);
      };
    };

    const applyDebounced = debounce(apply, 120);

    [search, status, consent, category, intervention].forEach((el) => {
      if (el) el.addEventListener('input', applyDebounced);
    });

    if (category instanceof HTMLSelectElement) {
      category.addEventListener('change', () => {
        updateInterventionOptions();
        if (intervention instanceof HTMLSelectElement) intervention.value = '';
        apply();
      });
    }

    if (resetBtn instanceof HTMLButtonElement) {
      resetBtn.addEventListener('click', () => {
        if (search instanceof HTMLInputElement) search.value = '';
        if (status instanceof HTMLSelectElement) status.value = '';
        if (consent instanceof HTMLSelectElement) consent.value = '';
        if (category instanceof HTMLSelectElement) category.value = '';
        updateInterventionOptions();
        if (intervention instanceof HTMLSelectElement) intervention.value = '';
        apply();
      });
    }

    if (clearBtn instanceof HTMLButtonElement && search instanceof HTMLInputElement) {
      clearBtn.addEventListener('click', () => {
        search.value = '';
        apply();
        search.focus();
      });
    }

    window.addEventListener('keydown', (event) => {
      if (event.key === '/' && search instanceof HTMLInputElement) {
        event.preventDefault();
        search.focus();
      }
      if (event.key === 'Escape' && search instanceof HTMLInputElement) {
        search.value = '';
        apply();
      }
    });

    setInitialState();
    apply();
  })();
</script>
