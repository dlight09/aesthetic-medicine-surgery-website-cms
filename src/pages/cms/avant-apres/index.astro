---
import CmsLayout from '@/layouts/CmsLayout.astro';
import { listCmsAvantApresCases, type AvantApresCaseView } from '@/lib/cms/avantApres';
import { getCollection } from 'astro:content';

Astro.response.headers.set('Cache-Control', 'no-store');
const statusClass = (status: 'publie' | 'brouillon') =>
  status === 'publie' ? 'bg-emerald-100 text-emerald-700' : 'bg-ink/10 text-ink/70';

type AvantApresCaseWithIntervention = AvantApresCaseView & {
  intervention_category?: string | null;
  intervention_slug?: string | null;
  description?: string | null;
};
const items = (await listCmsAvantApresCases()) as AvantApresCaseWithIntervention[];
const interventions = await getCollection('interventions');
const interventionTitleByRef = new Map(
  interventions.map((entry) => {
    const slug = entry.slug.split('/').filter(Boolean).slice(-1)[0] ?? entry.slug;
    return [`${entry.data.category}::${slug}`, entry.data.title];
  }),
);
const formatDate = (value: string) =>
  new Date(value).toLocaleDateString('fr-FR', { day: '2-digit', month: '2-digit', year: 'numeric' });
---

<CmsLayout title="Avant/Après">
  <div class="space-y-6">
    <div id="aa-toast" class="hidden rounded-2xl border border-emerald-200 bg-emerald-50 px-4 py-3 text-sm text-emerald-800">
      Cas publié avec succès.
    </div>
    <div id="aa-toast-delete" class="hidden rounded-2xl border border-rose-200 bg-rose-50 px-4 py-3 text-sm text-rose-700">
      Cas supprimé.
    </div>
    <div id="aa-toast-error" class="hidden rounded-2xl border border-rose-200 bg-rose-50 px-4 py-3 text-sm text-rose-700">
      Erreur de suppression.
    </div>
    <dialog id="aa-confirm" class="cms-drawer">
      <div class="cms-card-elevated mx-auto mt-28 w-[min(92vw,420px)] p-6">
        <div class="text-xs font-semibold uppercase tracking-wide text-ink/50">Suppression</div>
        <div class="mt-2 font-display text-2xl tracking-tight">Supprimer ce cas ?</div>
        <p class="mt-3 text-sm text-ink/70">Cette action est définitive et retire le cas du site.</p>
        <div class="mt-6 flex flex-wrap justify-end gap-3">
          <button type="button" data-cancel class="btn btn-pill btn-sm btn-secondary">Annuler</button>
          <button type="button" data-confirm class="btn btn-pill btn-sm btn-primary">Supprimer</button>
        </div>
      </div>
    </dialog>
    <div class="flex flex-wrap items-center justify-between gap-3">
      <div>
        <div class="text-xs font-semibold uppercase tracking-wide text-ink/50">Cas</div>
        <h1 class="mt-1 font-display text-3xl tracking-tight">Avant/Après</h1>
      </div>
      <a href="/cms/avant-apres/new" class="btn btn-pill btn-sm btn-primary">Nouveau cas</a>
    </div>

    <div class="cms-card p-6">
      <div class="grid gap-3 md:grid-cols-[1.2fr_0.7fr_0.7fr]">
        <label class="grid gap-2 text-sm">
          <span class="font-semibold text-ink/70">Recherche</span>
          <input id="aa-search" class="cms-input" placeholder="Titre, intervention..." />
        </label>
        <label class="grid gap-2 text-sm">
          <span class="font-semibold text-ink/70">Statut</span>
          <select id="aa-status" class="cms-select">
            <option value="">Tous</option>
            <option value="publie">Publié</option>
            <option value="brouillon">Brouillon</option>
          </select>
        </label>
        <label class="grid gap-2 text-sm">
          <span class="font-semibold text-ink/70">Consentement</span>
          <select id="aa-consent" class="cms-select">
            <option value="">Tous</option>
            <option value="true">Consent OK</option>
            <option value="false">Sans consentement</option>
          </select>
        </label>
      </div>
    </div>

    <div class="cms-card shadow-soft">
      <div class="grid grid-cols-[1.6fr_0.8fr_0.6fr_0.4fr] gap-4 border-b border-ink/10 px-6 py-4 text-xs font-semibold uppercase tracking-wide text-ink/50">
        <div>Cas</div>
        <div>Consentement</div>
        <div>Statut</div>
        <div>Actions</div>
      </div>
      <div id="aa-list" class="divide-y divide-ink/5">
        {items.map((item: AvantApresCaseWithIntervention) => (
          <div
            class="cms-row grid grid-cols-[1.6fr_0.8fr_0.6fr_0.4fr] gap-4 px-6 py-4 text-sm"
            data-row
            data-href={`/cms/avant-apres/${item.id}`}
            data-id={item.id}
            data-title={item.title.toLowerCase()}
            data-status={item.status}
            data-consent={item.consent ? 'true' : 'false'}
            data-intervention={(item.intervention_category && item.intervention_slug
              ? (interventionTitleByRef.get(`${item.intervention_category}::${item.intervention_slug}`) ?? '').toLowerCase()
              : '')}
            data-description={(item.description ?? '').toLowerCase()}
          >
            <div class="flex items-center gap-3">
              <div class="flex gap-2">
                <img src={item.beforeUrl} alt="Avant" class="h-10 w-14 rounded-lg object-cover" />
                <img src={item.afterUrl} alt="Après" class="h-10 w-14 rounded-lg object-cover" />
              </div>
              <div>
                <a href={`/cms/avant-apres/${item.id}`} class="font-semibold text-ink/90 hover:text-ink">
                  {item.title}
                </a>
                <div class="text-xs text-ink/60">MAJ: {formatDate(item.updated_at)}</div>
                {item.description ? (
                  <div class="text-xs text-ink/50">{item.description}</div>
                ) : null}
                {item.intervention_category && item.intervention_slug ? (
                  <div class="text-xs text-ink/50">
                    Intervention: {interventionTitleByRef.get(`${item.intervention_category}::${item.intervention_slug}`) ?? 'Non renseignée'}
                  </div>
                ) : null}
              </div>
            </div>
            <div>
              <span class:list={[
                'cms-pill',
                item.consent ? 'bg-emerald-100 text-emerald-700' : 'bg-rose-100 text-rose-700'
              ]}>
                {item.consent ? 'Consent OK' : 'Sans consentement'}
              </span>
            </div>
            <div>
              <span class:list={['cms-pill', statusClass(item.status)]}>
                {item.status === 'publie' ? 'Publié' : 'Brouillon'}
              </span>
            </div>
            <div>
              <button
                type="button"
                data-delete-row
                class="rounded-full border border-rose-200 bg-rose-50 px-3 py-1 text-xs font-semibold text-rose-700 hover:bg-rose-100"
              >
                Supprimer
              </button>
            </div>
          </div>
        ))}
      </div>
    </div>
  </div>
</CmsLayout>

<script is:inline>
  (() => {
    const toast = document.getElementById('aa-toast');
    const params = new URLSearchParams(window.location.search);
    if (toast instanceof HTMLElement && params.get('published') === '1') {
      toast.classList.remove('hidden');
      window.history.replaceState({}, '', window.location.pathname);
      setTimeout(() => toast.classList.add('hidden'), 3200);
    }

    const deleteToast = document.getElementById('aa-toast-delete');
    const errorToast = document.getElementById('aa-toast-error');
    const confirmDialog = document.getElementById('aa-confirm');
    const confirmBtn = confirmDialog?.querySelector('[data-confirm]');
    const cancelBtn = confirmDialog?.querySelector('[data-cancel]');
    let pendingDeleteId = '';
    if (deleteToast instanceof HTMLElement && params.get('deleted') === '1') {
      deleteToast.classList.remove('hidden');
      window.history.replaceState({}, '', window.location.pathname);
      setTimeout(() => deleteToast.classList.add('hidden'), 3200);
    }

    const list = document.getElementById('aa-list');
    const search = document.getElementById('aa-search');
    const status = document.getElementById('aa-status');
    const consent = document.getElementById('aa-consent');
    if (!(list instanceof HTMLElement)) return;

    list.addEventListener('click', async (event) => {
      const target = event.target instanceof HTMLElement ? event.target : null;
      if (!target) return;
      const deleteBtn = target.closest('[data-delete-row]');
      if (!deleteBtn) {
        const row = target.closest('[data-row]');
        if (row instanceof HTMLElement) {
          const href = row.dataset.href;
          if (href) window.location.href = href;
        }
        return;
      }
      const row = target.closest('[data-row]');
      if (!(row instanceof HTMLElement)) return;
      const caseId = row.dataset.id ?? '';
      if (!caseId) return;
      pendingDeleteId = caseId;
      if (confirmDialog instanceof HTMLDialogElement) confirmDialog.showModal();
    });

    if (confirmDialog instanceof HTMLDialogElement) {
      const close = () => confirmDialog.close();
      if (cancelBtn instanceof HTMLElement) cancelBtn.addEventListener('click', close);
      confirmDialog.addEventListener('click', (event) => {
        if (event.target === confirmDialog) close();
      });
    }

    if (confirmBtn instanceof HTMLButtonElement) {
      confirmBtn.addEventListener('click', async () => {
        const caseId = pendingDeleteId;
        if (!caseId) return;
        try {
          const res = await fetch(`/api/cms/avant-apres/${encodeURIComponent(caseId)}`, { method: 'DELETE' });
          if (!res.ok) throw new Error('delete');
          const row = list.querySelector(`[data-row][data-id="${caseId}"]`);
          if (row instanceof HTMLElement) row.remove();
          if (deleteToast instanceof HTMLElement) {
            deleteToast.classList.remove('hidden');
            setTimeout(() => deleteToast.classList.add('hidden'), 3200);
          }
        } catch (err) {
          if (errorToast instanceof HTMLElement) {
            errorToast.classList.remove('hidden');
            setTimeout(() => errorToast.classList.add('hidden'), 3200);
          }
        } finally {
          pendingDeleteId = '';
          if (confirmDialog instanceof HTMLDialogElement) confirmDialog.close();
        }
      });
    }

    const apply = () => {
      const q = search instanceof HTMLInputElement ? search.value.trim().toLowerCase() : '';
      const st = status instanceof HTMLSelectElement ? status.value : '';
      const co = consent instanceof HTMLSelectElement ? consent.value : '';
      const rows = list.querySelectorAll('[data-row]');
      rows.forEach((row) => {
        if (!(row instanceof HTMLElement)) return;
        const title = row.dataset.title ?? '';
        const rStatus = row.dataset.status ?? '';
        const rConsent = row.dataset.consent ?? '';
        const rIntervention = row.dataset.intervention ?? '';
        const description = row.dataset.description ?? '';
        const matchesQuery =
          !q || title.includes(q) || rIntervention.includes(q) || description.includes(q);
        const matchesStatus = !st || rStatus === st;
        const matchesConsent = !co || rConsent === co;
        row.style.display = matchesQuery && matchesStatus && matchesConsent ? '' : 'none';
      });
    };

    [search, status, consent].forEach((el) => {
      if (el) el.addEventListener('input', apply);
    });
  })();
</script>
