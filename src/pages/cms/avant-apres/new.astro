---
import CmsLayout from '@/layouts/CmsLayout.astro';
import { getCollection } from 'astro:content';
import { interventionCategories } from '@/lib/interventions';

const interventions = await getCollection('interventions');
const preselectedRef = Astro.url.searchParams.get('intervention_ref') ?? '';
const interventionsByCategory = interventionCategories.map((category) => {
  const items = interventions
    .filter((entry) => entry.data.category === category.key)
    .map((entry) => ({
      title: entry.data.title,
      slug: entry.slug.split('/').filter(Boolean).slice(-1)[0] ?? entry.slug,
      category: entry.data.category,
    }));
  return { label: category.title, key: category.key, items };
});
---

<CmsLayout title="Nouveau cas">
  <div class="grid gap-6 lg:grid-cols-[minmax(0,1fr)_320px]">
    <section class="cms-card p-7">
      <div class="text-xs font-semibold uppercase tracking-wide text-ink/50">Avant/Après</div>
      <h1 class="mt-2 font-display text-3xl tracking-tight">Nouveau cas</h1>

      <form id="aa-form" class="mt-8 grid gap-5">
        <label class="grid gap-2 text-sm">
          <span class="font-semibold text-ink/80">Intervention associée</span>
          <select class="cms-select" name="intervention_ref">
            <option value="">Aucune</option>
            {interventionsByCategory.map((group) => (
              <optgroup label={group.label}>
                {group.items.map((item) => (
                  <option
                    value={`${item.category}::${item.slug}`}
                    selected={preselectedRef === `${item.category}::${item.slug}`}
                  >
                    {item.title}
                  </option>
                ))}
              </optgroup>
            ))}
          </select>
          <span class="text-xs text-ink/50">Le titre du cas reprend l’intervention sélectionnée.</span>
        </label>
        <label class="grid gap-2 text-sm">
          <span class="font-semibold text-ink/80">Numéro du cas</span>
          <div class="cms-input flex items-center text-sm text-ink/70" data-case-display>—</div>
          <span class="text-xs text-ink/50">Attribué automatiquement selon l’intervention.</span>
        </label>

        <div class="grid gap-4 sm:grid-cols-2">
          <div class="rounded-2xl border border-ink/10 bg-mist p-4">
            <div class="text-xs font-semibold uppercase tracking-wide text-ink/50">Avant</div>
            <div data-placeholder="before" class="mt-3 flex h-32 items-center justify-center rounded-xl border border-dashed border-ink/20 bg-paper text-xs text-ink/40">
              Aperçu
            </div>
            <img data-preview="before" class="mt-3 hidden h-32 w-full rounded-xl object-cover" alt="" />
            <input type="file" accept="image/*" class="mt-3 block text-xs" data-upload="before" />
            <div class="mt-2 text-[11px] text-ink/50">JPG/PNG, 10MB max.</div>
            <div data-upload-status="before" class="mt-1 text-[11px] text-ink/60"></div>
            <div data-upload-error="before" class="mt-1 text-[11px] text-rose-600"></div>
            <input type="hidden" name="before_path" data-path="before" />
          </div>
          <div class="rounded-2xl border border-ink/10 bg-mist p-4">
            <div class="text-xs font-semibold uppercase tracking-wide text-ink/50">Après</div>
            <div data-placeholder="after" class="mt-3 flex h-32 items-center justify-center rounded-xl border border-dashed border-ink/20 bg-paper text-xs text-ink/40">
              Aperçu
            </div>
            <img data-preview="after" class="mt-3 hidden h-32 w-full rounded-xl object-cover" alt="" />
            <input type="file" accept="image/*" class="mt-3 block text-xs" data-upload="after" />
            <div class="mt-2 text-[11px] text-ink/50">JPG/PNG, 10MB max.</div>
            <div data-upload-status="after" class="mt-1 text-[11px] text-ink/60"></div>
            <div data-upload-error="after" class="mt-1 text-[11px] text-rose-600"></div>
            <input type="hidden" name="after_path" data-path="after" />
          </div>
        </div>

        <label class="grid gap-2 text-sm">
          <span class="font-semibold text-ink/80">Description avant / après</span>
          <textarea rows={3} class="cms-textarea" name="description"></textarea>
        </label>
      </form>
    </section>

    <aside class="cms-panel p-6">
      <div class="text-xs font-semibold uppercase tracking-wide text-ink/50">Consentement</div>
      <label class="mt-3 flex items-center gap-2 text-sm">
        <input type="checkbox" class="h-4 w-4" name="consent" form="aa-form" />
        <span>Consentement obtenu</span>
      </label>
      <label class="mt-4 grid gap-2 text-sm">
        <span class="font-semibold text-ink/80">Date du consentement</span>
        <input class="cms-input" type="date" name="consent_date" form="aa-form" />
      </label>
      <label class="mt-4 grid gap-2 text-sm">
        <span class="font-semibold text-ink/80">Référence interne</span>
        <input class="cms-input" placeholder="Ref dossier" name="internal_ref" form="aa-form" />
      </label>

      <div class="mt-6 space-y-3">
        <button
          type="submit"
          value="draft"
          name="intent"
          form="aa-form"
          data-submit
          class="btn btn-pill btn-md btn-primary w-full disabled:cursor-not-allowed disabled:opacity-60"
        >
          Enregistrer brouillon
        </button>
        <button
          type="submit"
          value="publish"
          name="intent"
          form="aa-form"
          data-submit
          class="btn btn-pill btn-md btn-secondary w-full disabled:cursor-not-allowed disabled:opacity-60"
        >
          Publier
        </button>
      </div>
      <div id="aa-status" class="mt-4 text-xs text-ink/60"></div>
      <div id="aa-error" class="mt-2 text-xs text-rose-600"></div>
    </aside>
  </div>
</CmsLayout>

<script is:inline>
  (() => {
    const form = document.getElementById('aa-form');
    const error = document.getElementById('aa-error');
    const status = document.getElementById('aa-status');
    const submitButtons = document.querySelectorAll('[data-submit]');
    const uploadState = { before: false, after: false };
      const caseDisplay = form.querySelector('[data-case-display]');
    const interventionSelect = form.querySelector('select[name="intervention_ref"]');
    if (!(form instanceof HTMLFormElement)) return;

    const uploadInputs = form.querySelectorAll('[data-upload]');
    const setSubmitDisabled = (disabled) => {
      submitButtons.forEach((btn) => {
        if (btn instanceof HTMLButtonElement) btn.disabled = disabled;
      });
    };

    const setUploadState = (kind, isUploading, message = '') => {
      uploadState[kind] = isUploading;
      const statusEl = form.querySelector(`[data-upload-status="${kind}"]`);
      if (statusEl instanceof HTMLElement) statusEl.textContent = message;
      setSubmitDisabled(uploadState.before || uploadState.after);
    };

    const refreshCaseNumber = async () => {
      if (!(interventionSelect instanceof HTMLSelectElement)) return;
      if (!(caseDisplay instanceof HTMLElement)) return;
      const value = interventionSelect.value;
      if (!value) {
        caseDisplay.textContent = '—';
        return;
      }
      try {
        const res = await fetch('/api/cms/avant-apres');
        if (!res.ok) throw new Error('fetch');
        const items = await res.json();
        const [cat, slug] = value.split('::');
        const numbers = items
          .filter((item) => item.intervention_category === cat && item.intervention_slug === slug)
          .map((item) => Number(item.case_number))
          .filter((n) => Number.isFinite(n));
        const nextNumber = (numbers.length ? Math.max(...numbers) : 0) + 1;
        caseDisplay.textContent = `Cas ${String(nextNumber).padStart(2, '0')}`;
      } catch (err) {
        caseDisplay.textContent = '—';
      }
    };

    if (interventionSelect instanceof HTMLSelectElement) {
      interventionSelect.addEventListener('change', refreshCaseNumber);
      refreshCaseNumber();
    }

    uploadInputs.forEach((input) => {
      if (!(input instanceof HTMLInputElement)) return;
      input.addEventListener('change', async () => {
        const file = input.files?.[0];
        const kind = input.dataset.upload;
        if (!file || (kind !== 'before' && kind !== 'after')) return;
        const errorEl = form.querySelector(`[data-upload-error="${kind}"]`);
        if (errorEl instanceof HTMLElement) errorEl.textContent = '';
        if (file.size > 10 * 1024 * 1024) {
          if (errorEl instanceof HTMLElement) errorEl.textContent = 'Fichier trop lourd (10MB max).';
          input.value = '';
          return;
        }
        try {
          if (error) error.textContent = '';
          if (status) status.textContent = '';
          setUploadState(kind, true, 'Upload en cours...');
          const res = await fetch('/api/cms/avant-apres/upload-url', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ fileName: file.name, kind })
          });
          if (!res.ok) throw new Error('upload-url');
          const data = await res.json();
          const uploadRes = await fetch(data.signedUrl, {
            method: 'PUT',
            headers: { 'Content-Type': file.type },
            body: file
          });
          if (!uploadRes.ok) throw new Error('upload');

          const pathInput = form.querySelector(`[data-path="${kind}"]`);
          if (pathInput instanceof HTMLInputElement) pathInput.value = data.path;
          const preview = form.querySelector(`[data-preview="${kind}"]`);
          const placeholder = form.querySelector(`[data-placeholder="${kind}"]`);
          if (preview instanceof HTMLImageElement) {
            preview.src = URL.createObjectURL(file);
            preview.classList.remove('hidden');
          }
          if (placeholder instanceof HTMLElement) placeholder.classList.add('hidden');
          setUploadState(kind, false, 'Upload terminé.');
        } catch (err) {
          setUploadState(kind, false, '');
          if (errorEl instanceof HTMLElement) {
            errorEl.textContent = "Erreur d'upload. Vérifiez votre connexion.";
          }
        }
      });
    });

    form.addEventListener('submit', async (event) => {
      event.preventDefault();
      if (error) error.textContent = '';
      if (status) status.textContent = 'Enregistrement...';
      const submitter = event.submitter;
      const intent = submitter && submitter instanceof HTMLButtonElement ? submitter.value : 'draft';
      const formData = new FormData(form);
      const interventionSelect = form.querySelector('select[name="intervention_ref"]');
      const interventionLabel =
        interventionSelect instanceof HTMLSelectElement
          ? interventionSelect.selectedOptions[0]?.textContent?.trim() ?? ''
          : '';
      const payload = {
        title: interventionLabel,
        description: String(formData.get('description') ?? '').trim() || null,
        intervention_category: null,
        intervention_slug: null,
        consent: formData.get('consent') === 'on',
        consent_date: String(formData.get('consent_date') ?? '').trim() || null,
        internal_ref: String(formData.get('internal_ref') ?? '').trim() || null,
        before_path: String(formData.get('before_path') ?? '').trim(),
        after_path: String(formData.get('after_path') ?? '').trim(),
        status: intent === 'publish' ? 'publie' : 'brouillon'
      };

      const interventionRef = String(formData.get('intervention_ref') ?? '').trim();
      if (interventionRef) {
        const [cat, slug] = interventionRef.split('::');
        payload.intervention_category = cat || null;
        payload.intervention_slug = slug || null;
      }

      if (!interventionRef || !payload.title) {
        if (error) error.textContent = 'Sélectionnez une intervention associée.';
        if (status) status.textContent = '';
        return;
      }

      if (intent === 'publish' && !payload.consent) {
        if (error) error.textContent = 'Le consentement est requis pour publier.';
        if (status) status.textContent = '';
        return;
      }

      if (!payload.title || !payload.before_path || !payload.after_path) {
        if (error) error.textContent = 'Intervention et photos avant/après obligatoires.';
        if (status) status.textContent = '';
        return;
      }

      try {
        const res = await fetch('/api/cms/avant-apres', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        if (!res.ok) throw new Error('save');
        const data = await res.json();
        if (status) status.textContent = 'Enregistré.';
        if (intent === 'publish') {
          window.location.href = '/cms/avant-apres?published=1';
          return;
        }
        window.location.href = `/cms/avant-apres/${data.id}`;
      } catch (err) {
        if (error) error.textContent = 'Erreur de sauvegarde.';
        if (status) status.textContent = '';
      }
    });
  })();
</script>
