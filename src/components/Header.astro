---
import { site } from '@/lib/site';
import { getCollection } from 'astro:content';
import {
  interventionCategories,
  interventionCategoryFallbackList,
  interventionCategoryHref,
  type InterventionCategoryKey
} from '@/lib/interventions';

const pathname = (() => {
  const p = Astro.url?.pathname || '/';
  if (p === '/') return '/';
  return p.endsWith('/') ? p.slice(0, -1) : p;
})();

function isActiveHref(href: string) {
  const h = href === '/' ? '/' : href.endsWith('/') ? href.slice(0, -1) : href;
  if (h === '/') return pathname === '/';
  return pathname === h || pathname.startsWith(`${h}/`);
}

const nav = [
  { href: '/', label: 'Accueil' },
  { href: '/dr-sirine-soussi', label: 'Dr Soussi' },
  { href: '/interventions', label: 'Interventions' },
  { href: '/avant-apres', label: 'Avant-Apres' },
  { href: '/blog', label: 'Blog' },
  { href: '/contact', label: 'Rendez-vous' },
];

function leafSlug(full: string) {
  const parts = full.split('/').filter(Boolean);
  return parts[parts.length - 1] ?? full;
}

const interventionEntries = await getCollection('interventions');
const megaInterventions = interventionCategories.map((c) => {
  const entries = interventionEntries
    .filter((i) => i.data.category === c.key)
    .sort((a, b) => (a.data.order ?? 999) - (b.data.order ?? 999))
    .slice(0, 4)
    .map((i) => ({
      label: i.data.title,
      href: `/interventions/${i.data.category}/${leafSlug(i.slug)}`
    }));

  const fallback = (interventionCategoryFallbackList[c.key as InterventionCategoryKey] ?? []).slice(0, 4);

  return {
    key: c.key,
    title: c.title,
    description: c.description,
    thumbnailSrc: c.thumbnailSrc,
    href: interventionCategoryHref(c.key),
    entries,
    fallback
  };
});
---

<header class="sticky top-0 z-40 border-b border-ink/10 bg-paper/80 backdrop-blur">
  <div class="relative mx-auto flex max-w-6xl items-center justify-between px-4 py-3">
    <a href="/" class="group flex items-baseline gap-2">
      <span class="font-display text-lg tracking-tight">{site.name}</span>
      <span class="hidden text-xs text-ink/65 sm:inline">{site.contact.city}</span>
    </a>

    <nav aria-label="Navigation principale" class="hidden items-center gap-1 text-sm sm:flex">
      {nav.map((i) => {
        const active = isActiveHref(i.href);

        if (i.href === '/interventions') {
          return (
            <div class="group" data-mega-root data-open="false">
              <div class="inline-flex items-center" data-mega-trigger>
                <a
                  href={i.href}
                  aria-current={active ? 'page' : undefined}
                  class:list={[
                    'rounded-full px-3 py-2 transition',
                    'text-ink/75 hover:text-ink',
                    'focus:outline-none focus-visible:ring-2 focus-visible:ring-copper/40',
                    active && 'bg-mist text-ink'
                  ]}
                >
                  <span class:list={[active && 'font-semibold']}>{i.label}</span>
                </a>

                <button
                  type="button"
                  class="-ml-1 inline-flex items-center justify-center rounded-full px-2 py-2 text-ink/65 transition hover:text-ink focus:outline-none focus-visible:ring-2 focus-visible:ring-copper/40"
                  aria-label="Ouvrir le menu Interventions"
                  aria-haspopup="true"
                  aria-expanded="false"
                  aria-controls="mega-interventions"
                  data-mega-toggle
                >
                  <svg
                    width="18"
                    height="18"
                    viewBox="0 0 24 24"
                    fill="none"
                    xmlns="http://www.w3.org/2000/svg"
                    aria-hidden="true"
                    class="transition-transform duration-200 group-data-[open=true]:rotate-180"
                  >
                    <path
                      d="M6 9L12 15L18 9"
                      stroke="currentColor"
                      stroke-width="1.75"
                      stroke-linecap="round"
                      stroke-linejoin="round"
                    />
                  </svg>
                </button>
              </div>

              <div
                class="absolute left-1/2 top-full z-50 mt-3 w-[min(72rem,calc(100vw-2rem))] -translate-x-1/2"
              >
                <div
                  id="mega-interventions"
                  class="mega-panel overflow-hidden rounded-2xl border border-ink/10 bg-paper shadow-lift"
                  aria-hidden="true"
                  data-mega-panel
                >
                  <div class="max-h-[calc(100vh-6.75rem)] overflow-y-auto overscroll-contain">
                    <div class="flex gap-8 p-6">
                      <div class="grid flex-1 grid-cols-3 gap-6">
                      {megaInterventions.map((c) => (
                        <div class="min-w-0">
                          <a
                            href={c.href}
                            class="inline-flex items-center gap-2 font-semibold text-ink/90 hover:text-ink"
                          >
                            <img
                              src={c.thumbnailSrc}
                              width="120"
                              height="90"
                              alt=""
                              loading="lazy"
                              class="h-8 w-10 rounded-lg border border-ink/10 object-cover"
                            />
                            <span class="truncate">{c.title}</span>
                            <span class="text-ink/35" aria-hidden="true">→</span>
                          </a>
                          <div class="mt-1 text-xs text-ink/60">{c.description}</div>

                          {c.entries.length ? (
                            <ul class="mt-3 space-y-1.5 text-sm">
                              {c.entries.map((x) => (
                                <li class="min-w-0">
                                  <a
                                    href={x.href}
                                    class="block truncate text-ink/75 hover:text-ink"
                                  >
                                    {x.label}
                                  </a>
                                </li>
                              ))}
                            </ul>
                          ) : c.fallback.length ? (
                            <ul class="mt-3 space-y-1.5 text-sm">
                              {c.fallback.map((x) => (
                                <li class="truncate text-ink/60">{x}</li>
                              ))}
                            </ul>
                          ) : (
                            <div class="mt-3 text-sm text-ink/60">Fiches detaillees a venir.</div>
                          )}

                          <a
                            href={c.href}
                            class="mt-3 inline-flex text-xs font-semibold text-ink/70 hover:text-ink"
                          >
                            Voir la categorie →
                          </a>
                        </div>
                      ))}
                    </div>

                      <aside class="sticky top-6 w-72 shrink-0 self-start">
                        <div class="rounded-2xl border border-ink/10 bg-mist p-5">
                          <div class="font-display text-xl tracking-tight">Prendre rendez-vous</div>
                          <p class="mt-2 text-sm text-ink/70">
                            Une question sur une intervention, les suites ou les indications? On en parle en consultation.
                          </p>
                          <div class="mt-4 grid gap-2">
                          <a
                            href="/contact"
                            class="inline-flex items-center justify-center rounded-xl bg-ink px-4 py-3 text-sm font-semibold text-paper"
                          >
                            Rendez-vous
                          </a>
                            <a
                              href={site.links.tel}
                              class="inline-flex items-center justify-center rounded-xl border border-ink/15 bg-paper px-4 py-3 text-sm font-semibold text-ink"
                            >
                              Appeler
                            </a>
                            <a
                              href={site.links.whatsapp}
                              class="inline-flex items-center justify-center rounded-xl border border-ink/15 bg-paper px-4 py-3 text-sm font-semibold text-ink"
                            >
                              WhatsApp
                            </a>
                          </div>
                          <div class="mt-4 text-xs text-ink/60">Reponse selon disponibilites.</div>
                        </div>
                      </aside>
                    </div>
                  </div>

                  <div class="flex items-center justify-between border-t border-ink/10 px-6 py-4">
                    <a href="/interventions" class="text-sm font-semibold text-ink/70 hover:text-ink">
                      Toutes les categories →
                    </a>
                    <a href="/contact" class="text-sm font-semibold text-ink/70 hover:text-ink">
                      Rendez-vous →
                    </a>
                  </div>
                </div>
              </div>
            </div>
          );
        }

        return (
          <a
            href={i.href}
            aria-current={active ? 'page' : undefined}
            class:list={[
              'rounded-full px-3 py-2 transition',
              'text-ink/75 hover:text-ink',
              'focus:outline-none focus-visible:ring-2 focus-visible:ring-copper/40',
              active && 'bg-mist text-ink'
            ]}
          >
            <span class:list={[active && 'font-semibold']}>{i.label}</span>
          </a>
        );
      })}
    </nav>

    <div class="flex items-center gap-2">
      <a
        href={site.links.whatsapp}
        class="hidden rounded-full border border-ink/15 bg-mist px-3 py-2 text-sm text-ink/80 transition hover:border-ink/25 hover:bg-paper sm:inline-flex"
      >
        WhatsApp
      </a>

      <button
        type="button"
        class="inline-flex items-center justify-center rounded-full border border-ink/15 bg-paper px-3 py-2 text-sm text-ink/80 transition hover:border-ink/25 hover:bg-mist focus:outline-none focus-visible:ring-2 focus-visible:ring-copper/40 sm:hidden"
        aria-haspopup="dialog"
        aria-controls="mobile-menu"
        data-menu-open
      >
        <span class="sr-only">Ouvrir le menu</span>
        <svg
          width="20"
          height="20"
          viewBox="0 0 24 24"
          fill="none"
          xmlns="http://www.w3.org/2000/svg"
          aria-hidden="true"
        >
          <path
            d="M4 7H20M4 12H20M4 17H20"
            stroke="currentColor"
            stroke-width="1.75"
            stroke-linecap="round"
          />
        </svg>
      </button>

      <a
        href={site.links.tel}
        class="inline-flex rounded-full bg-ink px-4 py-2 text-sm font-semibold text-paper shadow-soft transition hover:shadow-lift"
      >
        Appeler
      </a>
    </div>
  </div>

  <dialog
    id="mobile-menu"
    class="sm:hidden w-full max-w-none bg-transparent p-0"
    data-menu-dialog
  >
    <div class="fixed inset-0">
      <button
        type="button"
        class="fixed inset-0 bg-ink/30 backdrop-blur-sm"
        aria-label="Fermer le menu"
        data-menu-close
      ></button>

      <div class="relative mx-auto flex h-full max-w-6xl flex-col">
        <div class="flex-1 px-4 pt-4">
          <div class="mobile-menu-panel overflow-hidden rounded-2xl border border-ink/10 bg-paper shadow-lift">
            <div class="flex items-center justify-between border-b border-ink/10 px-4 py-3">
              <div class="flex items-baseline gap-2">
                <span class="font-display text-base tracking-tight">{site.name}</span>
                <span class="text-xs text-ink/65">{site.contact.city}</span>
              </div>
              <button
                type="button"
                class="inline-flex items-center justify-center rounded-full border border-ink/15 bg-paper px-3 py-2 text-sm text-ink/80 transition hover:border-ink/25 hover:bg-mist focus:outline-none focus-visible:ring-2 focus-visible:ring-copper/40"
                data-menu-close
              >
                <span class="sr-only">Fermer le menu</span>
                <svg
                  width="20"
                  height="20"
                  viewBox="0 0 24 24"
                  fill="none"
                  xmlns="http://www.w3.org/2000/svg"
                  aria-hidden="true"
                >
                  <path
                    d="M7 7L17 17M17 7L7 17"
                    stroke="currentColor"
                    stroke-width="1.75"
                    stroke-linecap="round"
                  />
                </svg>
              </button>
            </div>

            <nav aria-label="Navigation principale" class="px-2 py-2">
              {nav.map((i) => {
                const active = isActiveHref(i.href);
                return (
                  <a
                    href={i.href}
                    aria-current={active ? 'page' : undefined}
                    data-menu-link
                    class:list={[
                      'flex items-center justify-between rounded-xl px-3 py-3 text-base transition',
                      'focus:outline-none focus-visible:ring-2 focus-visible:ring-copper/40',
                      active ? 'bg-mist text-ink' : 'text-ink/85 hover:bg-mist'
                    ]}
                  >
                    <span class:list={[active && 'font-semibold']}>{i.label}</span>
                    <span class="text-ink/40" aria-hidden="true">→</span>
                  </a>
                );
              })}
            </nav>

            <div class="grid grid-cols-2 gap-2 border-t border-ink/10 px-4 py-3">
              <a
                href={site.links.tel}
                class="inline-flex items-center justify-center rounded-xl bg-ink px-4 py-3 text-sm font-semibold text-paper"
                data-menu-link
              >
                Appeler
              </a>
              <a
                href={site.links.whatsapp}
                class="inline-flex items-center justify-center rounded-xl border border-ink/15 bg-mist px-4 py-3 text-sm font-semibold text-ink"
                data-menu-link
              >
                WhatsApp
              </a>
            </div>
          </div>
        </div>
        <div class="h-8"></div>
      </div>
    </div>
  </dialog>

  <script is:inline>
    (() => {
      const openBtn = document.querySelector('[data-menu-open]');
      const dialog = document.querySelector('[data-menu-dialog]');
      if (!(openBtn instanceof HTMLElement)) return;
      if (!(dialog instanceof HTMLDialogElement)) return;

      const closeEls = dialog.querySelectorAll('[data-menu-close], [data-menu-link]');

      const lockScroll = (locked) => {
        document.documentElement.classList.toggle('menu-scroll-lock', locked);
        document.body.classList.toggle('menu-scroll-lock', locked);
      };

      const open = () => {
        if (dialog.open) return;
        dialog.showModal();
        lockScroll(true);
        const panel = dialog.querySelector('.mobile-menu-panel');
        const focusTarget = dialog.querySelector('[data-menu-close]');
        if (panel) panel.classList.add('mobile-menu-enter');
        if (focusTarget instanceof HTMLElement) focusTarget.focus();
      };

      const close = () => {
        if (!dialog.open) return;
        dialog.close();
      };

      openBtn.addEventListener('click', open);
      closeEls.forEach((el) => el.addEventListener('click', close));

      dialog.addEventListener('close', () => {
        lockScroll(false);
        const panel = dialog.querySelector('.mobile-menu-panel');
        if (panel) panel.classList.remove('mobile-menu-enter');
        openBtn.focus();
      });

      dialog.addEventListener('click', (e) => {
        // Click outside the panel closes the dialog.
        if (e.target === dialog) close();
      });
    })();
  </script>

  <script is:inline>
    (() => {
      const roots = document.querySelectorAll('[data-mega-root]');
      if (!roots.length) return;

      roots.forEach((root) => {
        const toggle = root.querySelector('[data-mega-toggle]');
        const trigger = root.querySelector('[data-mega-trigger]');
        const panel = root.querySelector('[data-mega-panel]');
        if (!(toggle instanceof HTMLButtonElement)) return;
        if (!(trigger instanceof HTMLElement)) return;
        if (!(panel instanceof HTMLElement)) return;

        let open = false;
        let openTimer;
        let closeTimer;

        const setOpen = (next) => {
          open = next;
          root.dataset.open = open ? 'true' : 'false';
          toggle.setAttribute('aria-expanded', open ? 'true' : 'false');
          panel.setAttribute('aria-hidden', open ? 'false' : 'true');
          panel.classList.toggle('mega-open', open);
        };

        const scheduleOpen = (delay = 70) => {
          window.clearTimeout(closeTimer);
          window.clearTimeout(openTimer);
          openTimer = window.setTimeout(() => setOpen(true), delay);
        };

        const scheduleClose = (delay = 180) => {
          window.clearTimeout(openTimer);
          window.clearTimeout(closeTimer);
          closeTimer = window.setTimeout(() => setOpen(false), delay);
        };

        // Hover: only open when user is on the trigger or panel.
        trigger.addEventListener('mouseenter', () => scheduleOpen(60));
        trigger.addEventListener('mouseleave', () => scheduleClose(220));
        panel.addEventListener('mouseenter', () => scheduleOpen(0));
        panel.addEventListener('mouseleave', () => scheduleClose(180));

        root.addEventListener('focusin', () => setOpen(true));
        root.addEventListener('focusout', (e) => {
          const next = e.relatedTarget;
          if (!(next instanceof Node)) return;
          if (!root.contains(next)) scheduleClose(0);
        });

        toggle.addEventListener('click', (e) => {
          e.preventDefault();
          setOpen(!open);
        });

        document.addEventListener('keydown', (e) => {
          if (e.key !== 'Escape') return;
          if (!open) return;
          setOpen(false);
          toggle.focus();
        });

        document.addEventListener('mousedown', (e) => {
          if (!open) return;
          const t = e.target;
          if (!(t instanceof Node)) return;
          if (root.contains(t)) return;
          setOpen(false);
        });
      });
    })();
  </script>
</header>
